---
slug: /damai/damai-pro/release-intro
sidebar_class_name: has-new-badge
---

# 大麦pro版本震撼来袭

我们都知道想进大厂难度确实比较高，有些小伙伴去面试虽然是实习生岗位，但依然会问你很刁钻的问题，来考验你的技术能力到底如何？

而我辅导的小伙伴就有不少人问到了架构方面的问题，就比如在项目的运行时，就会被问到：

- **Redis宕机了怎么办？**

- **MQ宕机了怎么办？**

- **MQ消息丢失了怎么办？**

- **MQ消息延迟消费了怎么办？**

- **数据库的余票数量和Redis中的不一致怎么办？**

- **Redis恢复后，丢失的数据要怎么恢复？**

等等一系列的这种令人头疼的问题！之前的 damai 项目关于这方面的问题有做过处理，但有些是人工处理，没有实现全面的自动化，有的面试官听着感觉比较普通，没有给人十足的亮点。

所以针对上述说的这种疑难杂症，特意开发出了 damai 项目的升级版本：<font size="5" color="#5575f6"> **damai_pro** </font>

## 一、大麦pro介绍

damai_pro 是在原有的 damai 项目做了一次重大的升级！不仅保留了原有的功能，而且在此基础上添加了很多新的解决方案。

**甭管是Redis宕机了、Redis和数据库不一致了、Redis恢复丢失的数据了、MQ宕机了、MQ数据丢失了，等等。。。**

**这些所有的问题全部在damai_pro版本中得到解决！**

**都是真实生产环境使用的实际落地解决方案，完完全全经得起考证**

为的就是让小伙伴去面试时，能做到无论面试问什么，问的多么的抠细节，用 damai_pro 项目全都能回答上来！

![](/img/damai/架构难点问题解决.png)

## 二、大麦pro细节的优化
damai_pro 除了解决上述提到的各种中间件宕机和数据库丢失的问题外，还对原有的逻辑进一步做了优化，将逻辑进行再次解耦，学习起来更加的清晰！

并且在数据方面也升级了可靠性，做到 **应该高可用的业务，那就高可用。应该强一致性的业务，那就强一致性。** 解决之前数据在极端的情况下可能会丢失的问题。

![](/img/damai/对账.png)

## 三、大麦pro的动态压测

对于高并发项目来说，**压测** 是必不可少的一个环节，只有通过压测，才能知道系统的瓶颈在哪里，才能知道系统能承受多大的压力。

而且通过压测还可以知道系统在不同的参数下，**性能提升了多少，能承受多大的压力**。

所以对于大麦pro项目来说，特意开发了 **动态压测** 的功能，来模拟生产中的实际业务场景。

大麦pro的节目详情有 **v1**、**v2** 两个版本，生成订单有 **v1**、**v2**、**v3**、**v4** 四个版本，所以对于这些不同的版本，都需要进行压测，来对比不同版本下的性能提升。

### 动态压测的详细介绍：
[👉 点击这里查看大麦pro动态压测的详细介绍](/damai/damai-pro/load-testing)

## 四、大麦pro的后台管理

### 重要性功能的完善
除了能解决上述的疑难杂症之外，还需要很多重要性的功能：

- 需要能实时的监控和查询关键数据，例如：余票数量、座位状态、订单状态，以及数据库中和Redis是否一致等。

- 对于关键性的操作，比如Redis扣减余票，MQ消息队列的发送和消费，也都要记录下来，方便后续排查问题。 

- 以及问题出现后，不能说解决完就完事了，还要知道问题出现的原因是什么？问题出现的时间是什么时候？

为此，专门开发了一个后台管理系统，来对这些问题进行实时的监控、查询、处理。

### 后台管理系统详细介绍

[👉 点击这里查看大麦pro后台管理系统的详细介绍](/damai/damai-pro/admin-console)

## 五、大麦pro分库分表的升级
### 5.1 基因法如何在分库分表下数据均匀分布

在分库分表场景中，原始算法存在严重的资源浪费问题：由于分库和分表使用了相同的"基因位"（ID的同一部分），导致8个物理表中约有4个表很少被使用，资源利用率仅约50%。

大麦pro通过**基因位分离**方案完美解决了这个问题：
- ✅ **分表**：使用分片键的低位bit（最右边的几位）
- ✅ **分库**：使用分片键的中高位bit（跳过表基因位后的几位）
- ✅ 两者使用的bit位完全不重叠，实现独立分布
- ✅ 在订单号生成时嵌入用户ID的基因，保证无论使用订单号还是用户ID查询，都能100%定位到同一个分片

这样做的好处是：将资源利用率从50%提升到100%，并且保证了查询的一致性。

[👉 点击这里查看基因法如何在分库分表下数据均匀分布的详细介绍](/damai/damai-pro/sharding/gene)

### 5.2 分库分表下数据如何扩容

传统的基因法虽然解决了数据均匀分布问题，但有个致命缺陷：**扩容困难**。由于订单号中已经硬编码了固定的库表基因，当业务增长需要扩容时，原有订单号中的路由信息就会失效。

大麦pro通过引入**虚拟分片路由**方案优雅地解决了这个问题：

**核心思想**：在物理分片和数据之间增加一层虚拟分片映射
```
数据 → 虚拟分片ID → 路由表 → 物理库表
```

**关键优势**：
- ✅ 将8个物理分片"细分"为1024个虚拟分片，扩容粒度从12.5%降低到约0.1%
- ✅ 扩容时只需调整虚拟分片到物理分片的映射关系，不需要改变订单号生成逻辑
- ✅ 支持分批迁移，可以分24次迁移，每次只迁移约2.1%的数据，大大降低风险
- ✅ 支持秒级切换和快速回滚，业务无感知

这样就真正做到了**一次设计，持续扩容**，彻底解决了分库分表扩容的难题。

[👉 点击这里查看虚拟分片路由的详细介绍](/damai/damai-pro/sharding/virtual/introduce)

## 六、大麦pro项目的总结
### 6.1 大麦普通版本的代码数量
大麦普通版本的代码量就已经很惊人了，不包含注释和空行，就只是Java代码本身，就达到了将近 <font size="5" color="#5575f6"> **2.5万行** </font> 代码

因为是真正的企业级别项目，又是高并发业务，所以要考虑的细节有很多很多，又加上了很多的亮点设计，所以代码量就会比较多，也说明了不是其他的玩具项目能比的
<img src="/img/damai/大麦代码行数.png" alt="表关系" width="100%" />


### 6.2 大麦pro版本的代码数量
而大麦pro版本的Java代码量更是达到了 <font size="5" color="#5575f6"> **3万多行** </font> 代码，比普通版本多了 <font size="5" color="#5575f6"> **5500行** </font> 代码

这是因为大麦pro解决了 **各种中间件宕机**、**数据不一致**、**数据丢失** 等问题，又加上了 **自动异常处理**、**消息记录**、**动态压测**、**后台管理系统**，**分库分表扩容**，所以代码量自然就会更多

<img src="/img/damai/大麦pro代码行数.png" alt="表关系" width="100%" />

<br/>
<br/>

到此，大麦pro可以说是一个非常完整的高并发项目了，不管从项目架构设计、高并发业务设计、高并发问题解决、数据一致性问题、实时监控查询、业务的详细压测
，等等。全部都做了非常完善的处理。

<font size="4" color="#f23d2e"> **可以说全网能达到这种完善程度的项目真的是寥寥无几，拿这个去提高技术和面试，绝对是没得说！** </font>


## 七、大麦pro项目的申请

damai_pro项目是本人花费了很多的精力才开发出来的，同时也为了更好的保护已经加入星球的小伙伴的权益。所以决定damai_pro项目不再进行开源，而是将项目放到了私有库中。

普通版本的damai项目依然还是正常开源，本人也依然会继续进行优化。开源地址为： [👉 点击这里跳转到damai项目](https://gitee.com/java-up-up/damai)

已经加入星球的小伙伴，可以按照以下指示来申请和学习damai_pro项目：[👉 点击这里学习damai_pro项目](https://articles.zsxq.com/id_m4d7ni4zwkbq.html)

## 八、目前有优惠券活动，别忘了先领取哦！

[👉 优惠券在这里领取哦！](/how-to-study/intro/coupon-reminder)