---
slug: /damai/damai-pro/sharding/virtual/introduce
sidebar_class_name: has-upgrade-badge
---
# è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±æ˜¯ä»€ä¹ˆ
## å‰ææ¦‚è¦
### ðŸŽ¯ åŸºå› æ³•çš„åˆè¡·
åœ¨è®¢å•è¡¨åˆ†åº“åˆ†è¡¨åœºæ™¯ä¸­ï¼Œé‡‡ç”¨äº†**åŸºå› æ³•**æ¥è§£å†³æ•°æ®è·¯ç”±é—®é¢˜ã€‚

æ ¸å¿ƒæ€è·¯å¾ˆç®€å•ï¼šåœ¨ç”Ÿæˆè®¢å•ç¼–å·æ—¶ï¼Œå°†åº“è¡¨çš„è·¯ç”±ä¿¡æ¯ï¼ˆåŸºå› ï¼‰åµŒå…¥å…¶ä¸­ã€‚è¿™æ ·æ— è®ºä½¿ç”¨è®¢å•ç¼–å·è¿˜æ˜¯ç”¨æˆ·IDï¼Œéƒ½èƒ½å‡†ç¡®å®šä½åˆ°æ•°æ®æ‰€åœ¨çš„åˆ†ç‰‡ã€‚

### âš ï¸ åŸºå› æ³•çš„è‡´å‘½ç¼ºé™·
ä½†æ˜¯ï¼Œè¿™ç§æ–¹æ¡ˆæœ‰ä¸ªæ— æ³•å›žé¿çš„é—®é¢˜ï¼š**æ‰©å®¹éš¾é¢˜** ðŸ’¥

ç”±äºŽè®¢å•ç¼–å·ä¸­å·²ç»ç¡¬ç¼–ç äº†å›ºå®šçš„åº“è¡¨åŸºå› ï¼ˆæ¯”å¦‚2åº“4è¡¨çš„åˆ†ç‰‡ä¿¡æ¯ï¼‰ï¼Œå½“ä¸šåŠ¡å¢žé•¿éœ€è¦æ‰©å®¹åˆ°4åº“8è¡¨æ—¶ï¼ŒåŽŸæœ‰è®¢å•ç¼–å·ä¸­çš„è·¯ç”±ä¿¡æ¯å°±ä¼šå¤±æ•ˆã€‚

è¿™æ—¶å€™ä½ ä¼šé¢ä¸´ä¸¤éš¾é€‰æ‹© ðŸ˜°ï¼š

+ è¦ä¹ˆå¯¹åŽ†å²æ•°æ®è¿›è¡Œå¤§è§„æ¨¡è¿ç§»ï¼Œé‡æ–°ç”Ÿæˆè®¢å•å·
+ è¦ä¹ˆç»´æŠ¤å¤šå¥—å¤æ‚çš„è·¯ç”±è§„åˆ™

æ— è®ºå“ªç§æ–¹æ¡ˆï¼Œéƒ½ä¼šå¸¦æ¥å·¨å¤§çš„è¿ç»´æˆæœ¬å’Œä¸šåŠ¡é£Žé™©ã€‚

### ðŸš€ è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±ï¼šä¼˜é›…çš„è§£å†³æ–¹æ¡ˆ
ä¸ºäº†å½»åº•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†**è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±**æ–¹æ¡ˆ âœ¨

æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨ç‰©ç†åˆ†ç‰‡å’Œè·¯ç”±è§„åˆ™ä¹‹é—´ï¼Œå¢žåŠ ä¸€å±‚è™šæ‹Ÿåˆ†ç‰‡æ˜ å°„è¡¨ã€‚å°†åŽŸæœ¬ç¡¬ç¼–ç åœ¨è®¢å•å·ä¸­çš„ç‰©ç†åˆ†ç‰‡ä¿¡æ¯ï¼Œè½¬æ¢ä¸ºè™šæ‹Ÿåˆ†ç‰‡IDã€‚

**æ‰©å®¹æ—¶çš„ä¼˜åŠ¿**ï¼š

+ âœ… åªéœ€è°ƒæ•´è™šæ‹Ÿåˆ†ç‰‡åˆ°ç‰©ç†åˆ†ç‰‡çš„æ˜ å°„å…³ç³»
+ âœ… ä¸éœ€è¦æ”¹å˜è®¢å•å·çš„ç”Ÿæˆé€»è¾‘
+ âœ… å®žçŽ°å¹³æ»‘æ‰©å®¹å’Œä¸šåŠ¡æ— æ„ŸçŸ¥è¿ç§»

çœŸæ­£åšåˆ°äº†**ä¸€æ¬¡è®¾è®¡ï¼ŒæŒç»­æ‰©å®¹** ðŸŽ‰

## ä¸€ã€æ ¸å¿ƒæ€æƒ³
### 1.1 ä»€ä¹ˆæ˜¯è™šæ‹Ÿåˆ†ç‰‡ï¼Ÿ
è™šæ‹Ÿåˆ†ç‰‡æ˜¯åœ¨**ç‰©ç†åˆ†ç‰‡**å’Œ**æ•°æ®**ä¹‹é—´å¢žåŠ çš„ä¸€å±‚**é€»è¾‘æ˜ å°„**ï¼š

```plain
æ•°æ® â†’ è™šæ‹Ÿåˆ†ç‰‡ID â†’ è·¯ç”±è¡¨ â†’ ç‰©ç†åº“è¡¨
```

### ä¸‰å±‚æž¶æž„ï¼š
```plain
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç¬¬1å±‚ï¼šæ•°æ®åŸºå›                         â”‚
â”‚   è®¢å•å·/ç”¨æˆ·ID â†’ åŸºå› ä½ï¼ˆ3ä½ï¼‰â†’ ç‰©ç†åˆ†ç‰‡ç´¢å¼•ï¼ˆ0-7ï¼‰      â”‚
â”‚   ä¾‹å¦‚ï¼šuserId=13 â†’ åŸºå› 101 â†’ ç‰©ç†åˆ†ç‰‡5                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬2å±‚ï¼šè™šæ‹Ÿåˆ†ç‰‡æ˜ å°„                      â”‚
â”‚   8ä¸ªç‰©ç†åˆ†ç‰‡ â†’ æ‰©å±•åˆ°1024ä¸ªè™šæ‹Ÿåˆ†ç‰‡                      â”‚
â”‚   æ¯ä¸ªç‰©ç†åˆ†ç‰‡å¯¹åº”128ä¸ªè™šæ‹Ÿåˆ†ç‰‡                           â”‚
â”‚   - ç‰©ç†åˆ†ç‰‡0 â†’ è™šæ‹Ÿåˆ†ç‰‡0-127                            â”‚
â”‚   - ç‰©ç†åˆ†ç‰‡1 â†’ è™šæ‹Ÿåˆ†ç‰‡128-255                          â”‚
â”‚   - ...                                                 â”‚
â”‚   - ç‰©ç†åˆ†ç‰‡7 â†’ è™šæ‹Ÿåˆ†ç‰‡896-1023                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç¬¬3å±‚ï¼šè·¯ç”±è¡¨æ˜ å°„                        â”‚
â”‚   è™šæ‹Ÿåˆ†ç‰‡ID â†’ å®žé™…ç‰©ç†åº“è¡¨ï¼ˆå¯åŠ¨æ€è°ƒæ•´ï¼‰                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚è™šæ‹Ÿåˆ†ç‰‡IDâ”‚  ç‰©ç†åº“    â”‚  ç‰©ç†è¡¨    â”‚                â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚
â”‚   â”‚    0     â”‚ damai_order_0 â”‚ d_order_0 â”‚ â† åˆå§‹é…ç½®  â”‚
â”‚   â”‚    1     â”‚ damai_order_0 â”‚ d_order_0 â”‚              â”‚
â”‚   â”‚   ...    â”‚    ...     â”‚    ...     â”‚                â”‚
â”‚   â”‚   127    â”‚ damai_order_0 â”‚ d_order_0 â”‚              â”‚
â”‚   â”‚   128    â”‚ damai_order_0 â”‚ d_order_1 â”‚              â”‚
â”‚   â”‚   ...    â”‚    ...     â”‚    ...     â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                          â”‚
â”‚   æ‰©å®¹æ—¶ä¿®æ”¹ï¼ˆåœ¨çŽ°æœ‰åº“ä¸­å¢žåŠ è¡¨ï¼‰ï¼š                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚    0     â”‚ damai_order_0 â”‚ d_order_4 â”‚ â† è¿ç§»åŽ    â”‚
â”‚   â”‚    1     â”‚ damai_order_0 â”‚ d_order_0 â”‚              â”‚
â”‚   â”‚   ...    â”‚    ...     â”‚    ...     â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒä¼˜åŠ¿
| ç»´åº¦ | ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆæ— è™šæ‹Ÿåˆ†ç‰‡ï¼‰ | è™šæ‹Ÿåˆ†ç‰‡æ–¹æ¡ˆ |
| --- | --- | --- |
| **æ‰©å®¹æ–¹å¼** | æ–°å¢žåº“æˆ–è¡¨ï¼Œæ•´ä½“è¿ç§» | åœ¨çŽ°æœ‰åº“ä¸­å¢žåŠ è¡¨ï¼Œæ‹†åˆ†è¿ç§» |
| **æ‰©å®¹ç²’åº¦** | 1/24ï¼ˆæ•´ä¸ªç‰©ç†åˆ†ç‰‡ï¼Œçº¦4.2%æ•°æ®ï¼‰ | 24ä¸ªç‰©ç†åˆ†ç‰‡â†’48ä¸ªï¼ˆæ¯å¼ è¡¨æ‹†åŠï¼Œåˆ†æ‰¹è¿ç§»ï¼‰ |
| **å•æ¬¡è¿ç§»é‡** | æ•´å¼ è¡¨å…¨éƒ¨æ•°æ® | æ¯å¼ è¡¨çš„åŽåŠéƒ¨åˆ†ï¼ˆçº¦2.1%æ€»æ•°æ®ï¼‰ |
| **çµæ´»æ€§** | ä½Žï¼ˆä¸€æ¬¡æ€§è¿ç§»ï¼‰ | é«˜ï¼ˆå¯åˆ†24æ¬¡è¿ç§»ï¼Œæ¯æ¬¡1å¼ è¡¨ï¼‰ |
| **æ¶‰åŠè¡¨ç±»åž‹** | è®¢å•è¡¨ã€è´­ç¥¨äººè®¢å•è¡¨ã€è®¢å•è®°å½•è¡¨ | åŒå·¦ï¼ˆ3ç±»è¡¨å…±äº«è·¯ç”±è¡¨ï¼‰ |
| **é£Žé™©ç­‰çº§** | è¾ƒé«˜ | è¾ƒä½Žï¼ˆå¯åˆ†æ‰¹æ‰§è¡Œï¼‰ |
| **å›žæ»šèƒ½åŠ›** | å›°éš¾ï¼ˆéœ€è¿ç§»å›žåŽ»ï¼‰ | ç®€å•ï¼ˆä¿®æ”¹è·¯ç”±è¡¨å³å¯ï¼‰ |
| **ä»£ç æ”¹åŠ¨** | å¯èƒ½éœ€è¦ | ä¸éœ€è¦ï¼ˆåªæ”¹è·¯ç”±è¡¨ï¼‰ |


---

## äºŒã€è®¾è®¡åŽŸç†
### 2.1 è®¢å•å·ç”Ÿæˆï¼ˆä¿æŒåŽŸæœ‰é€»è¾‘ï¼‰
**å…³é”®**ï¼šè®¢å•å·ç”Ÿæˆé€»è¾‘**å®Œå…¨ä¸å˜**ï¼ŒåªåµŒå…¥3ä½åŸºå› ã€‚

```java
/**
 * ç”Ÿæˆè®¢å•ç¼–å·ï¼ˆåŸºå› æ³•ï¼‰
 * 
 * åµŒå…¥ä¿¡æ¯ï¼š
 * - è¡¨åŸºå› ï¼ˆ2ä½ï¼‰ï¼š2^2 = 4ä¸ªè¡¨
 * - åº“åŸºå› ï¼ˆ1ä½ï¼‰ï¼š2^1 = 2ä¸ªåº“
 * - æ€»è®¡ï¼š3ä½åŸºå› 
 * 
 * @param userId ç”¨æˆ·ID
 * @param tableCount åˆ†è¡¨æ•°é‡ï¼ˆ4ï¼‰
 * @param databaseCount åˆ†åº“æ•°é‡ï¼ˆ2ï¼‰
 * @return è®¢å•ç¼–å·
 */
public synchronized long getOrderNumber(long userId, long tableCount, long databaseCount) {
    //çœç•¥...
}
```

**ç¤ºä¾‹**ï¼ˆ2åº“Ã—4è¡¨ï¼‰ï¼š

| ç”¨æˆ·ID | äºŒè¿›åˆ¶ | åŽ3ä½ï¼ˆåŸºå› ï¼‰ | è®¢å•å·æœ€åŽ3ä½ | ç‰©ç†åˆ†ç‰‡ |
| --- | --- | --- | --- | --- |
| 1 | 001 | 001 | 001 | db_0.table_1 |
| 2 | 010 | 010 | 010 | db_0.table_2 |
| 3 | 011 | 011 | 011 | db_0.table_3 |
| 4 | 100 | 100 | 100 | db_1.table_0 |
| 5 | 101 | 101 | 101 | db_1.table_1 |


### 2.2 è™šæ‹Ÿåˆ†ç‰‡è®¡ç®—ï¼ˆæ ¸å¿ƒç®—æ³•ï¼‰
#### æ ¸å¿ƒæ¦‚å¿µï¼šè™šæ‹Ÿåˆ†ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿ
### é—®é¢˜èƒŒæ™¯ï¼š
+ åŽŸå§‹ç‰©ç†åˆ†ç‰‡åªæœ‰8ä¸ªï¼ˆ2åº“Ã—4è¡¨ï¼‰
+ æ‰©å®¹æ—¶æœ€å°å•ä½æ˜¯1/8ï¼ˆ12.5%ï¼‰ï¼Œç²’åº¦å¤ªç²—
+ éœ€è¦æ›´çµæ´»çš„æ‰©å®¹ç²’åº¦

### è™šæ‹Ÿåˆ†ç‰‡è§£å†³æ–¹æ¡ˆï¼š
+ å°†8ä¸ªç‰©ç†åˆ†ç‰‡"ç»†åˆ†"ä¸º1024ä¸ªè™šæ‹Ÿåˆ†ç‰‡
+ æ¯ä¸ªç‰©ç†åˆ†ç‰‡å¯¹åº”128ä¸ªè™šæ‹Ÿåˆ†ç‰‡ï¼ˆ1024 Ã· 8 = 128ï¼‰
+ æ‰©å®¹æ—¶å¯ä»¥æŒ‰è™šæ‹Ÿåˆ†ç‰‡è¿ç§»ï¼Œç²’åº¦å˜ç»†

### è™šæ‹Ÿåˆ†ç‰‡æ˜ å°„å›¾ï¼š
```plain
ç‰©ç†åˆ†ç‰‡          è™šæ‹Ÿåˆ†ç‰‡èŒƒå›´          è¯´æ˜Ž
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ç‰©ç†åˆ†ç‰‡0   â†’   è™šæ‹Ÿåˆ†ç‰‡0-127      (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡1   â†’   è™šæ‹Ÿåˆ†ç‰‡128-255    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡2   â†’   è™šæ‹Ÿåˆ†ç‰‡256-383    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡) â† ç¤ºä¾‹åœ¨è¿™é‡Œ
ç‰©ç†åˆ†ç‰‡3   â†’   è™šæ‹Ÿåˆ†ç‰‡384-511    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡4   â†’   è™šæ‹Ÿåˆ†ç‰‡512-639    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡5   â†’   è™šæ‹Ÿåˆ†ç‰‡640-767    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡6   â†’   è™šæ‹Ÿåˆ†ç‰‡768-895    (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
ç‰©ç†åˆ†ç‰‡7   â†’   è™šæ‹Ÿåˆ†ç‰‡896-1023   (128ä¸ªè™šæ‹Ÿåˆ†ç‰‡)
```

### è®¡ç®—é€»è¾‘ï¼ˆä¸¤æ­¥å®šä½ï¼‰ï¼š
```plain
ç¬¬1æ­¥ï¼šæ ¹æ®åŸºå› ä½ç¡®å®š "å¤§åŒºåŸŸ"ï¼ˆç‰©ç†åˆ†ç‰‡ç´¢å¼•ï¼‰
       â†’ ç¡®å®šæ•°æ®åœ¨8ä¸ªç‰©ç†åˆ†ç‰‡ä¸­çš„å“ªä¸€ä¸ª

ç¬¬2æ­¥ï¼šæ ¹æ®æ¨¡è¿ç®—ç¡®å®š"å°åŒºåŸŸ"ï¼ˆè™šæ‹Ÿåˆ†ç‰‡å†…åç§»ï¼‰
       â†’ ç¡®å®šæ•°æ®åœ¨128ä¸ªè™šæ‹Ÿåˆ†ç‰‡ä¸­çš„å“ªä¸€ä¸ª

æœ€ç»ˆï¼šè™šæ‹Ÿåˆ†ç‰‡ID = ç‰©ç†åˆ†ç‰‡ç´¢å¼• Ã— 128 + è™šæ‹Ÿåç§»
```

### å½¢è±¡æ¯”å–»ï¼š
```plain
å°±åƒæ‰¾ä¸€æœ¬ä¹¦ï¼š
1. å…ˆæ‰¾ä¹¦æŸœï¼ˆç‰©ç†åˆ†ç‰‡ç´¢å¼•ï¼š0-7ï¼Œå…±8ä¸ªä¹¦æŸœï¼‰
2. å†æ‰¾ä¹¦æž¶ï¼ˆè™šæ‹Ÿåç§»ï¼š0-127ï¼Œæ¯ä¸ªä¹¦æŸœæœ‰128ä¸ªä¹¦æž¶ï¼‰
3. æœ€ç»ˆä½ç½® = ä¹¦æŸœå· Ã— 128 + ä¹¦æž¶å·

ç¤ºä¾‹ï¼š
- ä¹¦æŸœ2ï¼ˆç‰©ç†åˆ†ç‰‡2ï¼‰ï¼Œä¹¦æž¶82ï¼ˆè™šæ‹Ÿåç§»82ï¼‰
- æœ€ç»ˆä½ç½® = 2 Ã— 128 + 82 = 338å·ä¹¦æž¶
```

---

è™šæ‹Ÿåˆ†ç‰‡çš„æ ¸å¿ƒé€»è¾‘éƒ½æ”¾åˆ°äº†`calculateLogicalShardId`æ–¹æ³•ä¸­ï¼ŒåŽç»­åœ¨è®²è§£ä»£ç æµç¨‹æ—¶ï¼Œä¼šè¯¦ç»†çš„è®²è§£æ­¤æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹

```java
public int calculateLogicalShardId(Long shardingKey)
```

## ä¸‰ã€è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±è¡¨çš„è®¾è®¡
### 3.1 è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±è¡¨ç»“æž„
```sql
CREATE TABLE `d_sharding_route_mapping` (
  -- çœç•¥å…¶ä»–å­—æ®µ
  `logical_shard_id` int NOT NULL COMMENT 'é€»è¾‘åˆ†ç‰‡IDï¼ˆ0-1023ï¼‰',
  -- çœç•¥å…¶ä»–å­—æ®µ
) ENGINE=InnoDB COMMENT='è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±æ˜ å°„è¡¨';
```

### 3.2 è¡¨å­—æ®µ logical_shard_id è¯¦ç»†è§£é‡Š
#### ðŸ“š 3.2.1 ä»€ä¹ˆæ˜¯ logical_shard_idï¼Ÿ
`logical_shard_id` = è™šæ‹Ÿåˆ†ç‰‡ID = é€»è¾‘åˆ†ç‰‡ID

+ **èŒƒå›´**ï¼š0 - 1023ï¼ˆæ€»å…±1024ä¸ªè™šæ‹Ÿåˆ†ç‰‡ï¼‰
+ **ä½œç”¨**ï¼šåœ¨ç‰©ç†åˆ†ç‰‡ï¼ˆ8ä¸ªï¼‰å’Œåˆ†ç‰‡é”®ä¹‹é—´å»ºç«‹ä¸€ä¸ªä¸­é—´æ˜ å°„å±‚

#### ðŸŽ¯ 3.2.2 ä¸ºä»€ä¹ˆéœ€è¦è™šæ‹Ÿåˆ†ç‰‡ï¼Ÿ
å¯¹æ¯”ä¸¤ç§æ–¹æ¡ˆï¼š

| æ–¹æ¡ˆ | æ˜ å°„æ–¹å¼ | æ‰©å®¹æ–¹å¼ | çµæ´»æ€§ |
| --- | --- | --- | --- |
| **ç›´æŽ¥æ˜ å°„** | åˆ†ç‰‡é”® â†’ ç‰©ç†è¡¨ | å¿…é¡»è¿ç§»æ•´å¼ è¡¨ | âŒ ä½Ž |
| **è™šæ‹Ÿåˆ†ç‰‡** | åˆ†ç‰‡é”® â†’ è™šæ‹Ÿåˆ†ç‰‡ID â†’ ç‰©ç†è¡¨ | åªè¿ç§»éƒ¨åˆ†è™šæ‹Ÿåˆ†ç‰‡ | âœ… é«˜ |


#### 3.2.3 ç¤ºä¾‹å¯¹æ¯”ï¼š
```plain
âŒ æ²¡æœ‰è™šæ‹Ÿåˆ†ç‰‡ï¼š
   orderNumber â†’ hashè®¡ç®— â†’ damai_order_0.d_order_2
   æ‰©å®¹æ—¶ï¼šd_order_2 çš„æ‰€æœ‰æ•°æ®éƒ½è¦è¿ç§»

âœ… æœ‰è™šæ‹Ÿåˆ†ç‰‡ï¼š
   orderNumber â†’ è®¡ç®— â†’ è™šæ‹Ÿåˆ†ç‰‡338 â†’ æŸ¥è·¯ç”±è¡¨ â†’ damai_order_0.d_order_2
   æ‰©å®¹æ—¶ï¼šåªè¿ç§»è™šæ‹Ÿåˆ†ç‰‡320-383ï¼ˆä¸€åŠæ•°æ®ï¼‰åˆ°æ–°è¡¨
```

#### 3.2.4 ðŸ“Š è™šæ‹Ÿåˆ†ç‰‡çš„åˆ†é…è§„åˆ™
åˆå§‹çŠ¶æ€ï¼ˆ2åº“Ã—4è¡¨=8ä¸ªç‰©ç†åˆ†ç‰‡ï¼‰ï¼š

+ 1024ä¸ªè™šæ‹Ÿåˆ†ç‰‡ Ã· 8ä¸ªç‰©ç†åˆ†ç‰‡ = **æ¯ä¸ªç‰©ç†åˆ†ç‰‡128ä¸ªè™šæ‹Ÿåˆ†ç‰‡**

| ç‰©ç†åˆ†ç‰‡ | ç‰©ç†åº“è¡¨ | è™šæ‹Ÿåˆ†ç‰‡IDèŒƒå›´ | è™šæ‹Ÿåˆ†ç‰‡æ•°é‡ |
| --- | --- | --- | --- |
| ç‰©ç†åˆ†ç‰‡0 | db_0.table_0 | 0-127 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡1 | db_0.table_1 | 128-255 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡2 | db_0.table_2 | 256-383 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡3 | db_0.table_3 | 384-511 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡4 | db_1.table_0 | 512-639 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡5 | db_1.table_1 | 640-767 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡6 | db_1.table_2 | 768-895 | 128ä¸ª |
| ç‰©ç†åˆ†ç‰‡7 | db_1.table_3 | 896-1023 | 128ä¸ª |


### 3.3 ðŸ”§ SQL ç”Ÿæˆé€»è¾‘è¯¦è§£
ä»¥ç¬¬ä¸€ä¸ªç‰©ç†åˆ†ç‰‡ä¸ºä¾‹ï¼ˆç”Ÿæˆ 0-127ï¼‰ï¼š

```sql
SELECT 0 + a + b*10 + c*100 AS n 
FROM 
    (SELECT 0 AS a UNION SELECT 1 ... UNION SELECT 9) t1,  -- ä¸ªä½
    (SELECT 0 AS b UNION SELECT 1 ... UNION SELECT 9) t2,  -- åä½
    (SELECT 0 AS c UNION SELECT 1) t3                       -- ç™¾ä½
WHERE n >= 0 AND n <= 127;
```

**åŽŸç†**ï¼šç¬›å¡å°”ç§¯ + æ•°å­¦ç»„åˆ

1. **ç”Ÿæˆä¸ªä½ã€åä½ã€ç™¾ä½çš„æ‰€æœ‰ç»„åˆ**
    - t1ï¼ˆä¸ªä½ï¼‰ï¼š0, 1, 2, 3, 4, 5, 6, 7, 8, 9
    - t2ï¼ˆåä½ï¼‰ï¼š0, 1, 2, 3, 4, 5, 6, 7, 8, 9
    - t3ï¼ˆç™¾ä½ï¼‰ï¼š0, 1
2. **ç¬›å¡å°”ç§¯**ï¼ˆ10 Ã— 10 Ã— 2 = 200 ç§ç»„åˆï¼‰

| ç™¾ä½ | åä½ | ä¸ªä½ | è®¡ç®—å…¬å¼ | ç»“æžœ | æ˜¯å¦ä¿ç•™ |
| --- | --- | --- | --- | --- | --- |
| 0 | 0 | 0 | 0+0+0 | 0 | âœ… |
| 0 | 0 | 1 | 0+0+1 | 1 | âœ… |
| 0 | 1 | 0 | 0+10+0 | 10 | âœ… |
| ... | ... | ... | ... | ... | ... |
| 1 | 2 | 7 | 100+20+7 | 127 | âœ… |
| 1 | 2 | 8 | 100+20+8 | 128 | âŒ è¶…å‡ºèŒƒå›´ |
| 1 | 2 | 9 | 100+20+9 | 129 | âŒ è¶…å‡ºèŒƒå›´ |


3. **WHERE è¿‡æ»¤**ï¼š`WHERE n >= 0 AND n <= 127` ä¿ç•™128æ¡è®°å½•

#### 3.3.1 â“ ä¸ºä»€ä¹ˆçœ‹èµ·æ¥"æœ‰å¤§æœ‰å°ï¼Œä¸æ˜¯é€’å¢žçš„"ï¼Ÿ
åŽŸå› ï¼š**ç¬›å¡å°”ç§¯çš„æ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼**

æ•°æ®åº“åœ¨æ‰§è¡Œç¬›å¡å°”ç§¯æ—¶ï¼Œå¯èƒ½æŒ‰ä»¥ä¸‹ä»»æ„é¡ºåºç”Ÿæˆï¼š

+ æ–¹å¼1ï¼šå…ˆå›ºå®šcã€bï¼ŒéåŽ†a â†’ 0, 1, 2, ..., 9, 10, 11, ...
+ æ–¹å¼2ï¼šå…ˆå›ºå®šcã€aï¼ŒéåŽ†b â†’ 0, 10, 20, ..., 1, 11, 21, ...
+ æ–¹å¼3ï¼šå®Œå…¨éšæœºé¡ºåº â†’ 5, 23, 1, 67, 34, 12, ...

**ä½†æ˜¯ï¼æœ€ç»ˆç»“æžœæ˜¯ç¡®å®šçš„**ï¼š

+ âœ… ä¸€å®šåŒ…å«0-127çš„æ‰€æœ‰æ•°å­—ï¼ˆä¸€ä¸ªä¸å¤šï¼Œä¸€ä¸ªä¸å°‘ï¼‰
+ âœ… åªæ˜¯æ’å…¥é¡ºåºå¯èƒ½ä¸åŒ
+ âœ… SELECT æ—¶å¯ä»¥ç”¨ `ORDER BY logical_shard_id` æŽ’åºæŸ¥çœ‹

**éªŒè¯SQL**ï¼š

```sql
-- æŽ’åºæŸ¥çœ‹ï¼Œç»“æžœä¸€å®šæ˜¯è¿žç»­çš„ 0, 1, 2, ..., 127
SELECT * FROM d_sharding_route_mapping 
WHERE physical_database_suffix = '0' 
  AND physical_table_suffix = 0
ORDER BY logical_shard_id;
```

### 3.4  ðŸŽ¨ è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±è¡¨çš„å½¢è±¡æ¯”å–»
#### æ¯”å–»1ï¼šåœè½¦åœºçš„è½¦ä½ç¼–å·
+ åœè½¦åœºæœ‰1024ä¸ªè½¦ä½ï¼Œåˆ†ä¸º8ä¸ªåœè½¦åŒºï¼ˆA-HåŒºï¼‰
+ è½¦ä½ç¼–å·ï¼ˆlogical_shard_idï¼‰ï¼š
    - AåŒºï¼š0-127å·è½¦ä½
    - BåŒºï¼š128-255å·è½¦ä½
    - ...
    - HåŒºï¼š896-1023å·è½¦ä½
+ æ‰©å®¹æ—¶ï¼šAåŒºæ‹†åˆ†ä¸º A1åŒºï¼ˆ0-63å·ï¼‰+ A2åŒºï¼ˆ64-127å·ï¼‰
+ **è½¦ä½å·ç ä¸å˜ï¼Œåªæ˜¯å½’å±žåŒºåŸŸå˜äº†ï¼**

#### æ¯”å–»2ï¼šå¿«é€’åˆ†æ‹£ä¸­å¿ƒ
+ 1024ä¸ªåŒ…è£¹æ ¼å­ï¼ˆlogical_shard_id: 0-1023ï¼‰
+ 8ä¸ªé…é€ç«™ï¼ˆç‰©ç†åˆ†ç‰‡ï¼‰
+ åˆå§‹åˆ†é…ï¼šé…é€ç«™1è´Ÿè´£æ ¼å­0-127ï¼Œé…é€ç«™2è´Ÿè´£128-255ï¼Œ...
+ æ‰©å®¹æ—¶ï¼šé…é€ç«™1æ‹†åˆ†ä¸ºç«™1Aï¼ˆæ ¼å­0-63ï¼‰+ ç«™1Bï¼ˆæ ¼å­64-127ï¼‰
+ **åªéœ€æ›´æ–°"æ ¼å­å½’å±žè¡¨"ï¼ŒåŒ…è£¹è®¡ç®—é€»è¾‘ä¸å˜ï¼**

### 3.5 ðŸ“ å®Œæ•´ç¤ºä¾‹
**å‡è®¾ï¼š** `orderNumber = 1234567890`

```plain
æ­¥éª¤1ï¼šè®¡ç®—è™šæ‹Ÿåˆ†ç‰‡ID
   calculateLogicalShardId(1234567890)
   â†’ æå–åŸºå› ä½ï¼ˆåŽ3ä½ï¼‰â†’ physicalShardIndex = 2
   â†’ æ¨¡128 â†’ virtualOffset = 82
   â†’ logicalShardId = 2 Ã— 128 + 82 = 338

æ­¥éª¤2ï¼šæŸ¥è¯¢è·¯ç”±è¡¨
   SELECT * FROM d_sharding_route_mapping WHERE logical_shard_id = 338;
   ç»“æžœï¼šphysical_database_suffix='0', physical_table_suffix=2

æ­¥éª¤3ï¼šæ‹¼æŽ¥ç‰©ç†è¡¨å
   database = 'damai_order_0'
   table = 'd_order_2'
   
æœ€ç»ˆè·¯ç”±åˆ°ï¼šdamai_order_0.d_order_2
```

### 3.6 ðŸš€ æ‰©å®¹æ—¶çš„å¦™ç”¨
#### åˆå§‹çŠ¶æ€ï¼š
```plain
ç‰©ç†åˆ†ç‰‡2ï¼ˆdamai_order_0.d_order_2ï¼‰â†’ è™šæ‹Ÿåˆ†ç‰‡256-383ï¼ˆ128ä¸ªï¼‰
```

#### æ‰©å®¹åŽï¼š
```plain
è™šæ‹Ÿåˆ†ç‰‡256-319ï¼ˆ64ä¸ªï¼‰â†’ ä¿ç•™åœ¨ d_order_2
è™šæ‹Ÿåˆ†ç‰‡320-383ï¼ˆ64ä¸ªï¼‰â†’ è¿ç§»åˆ° d_order_6ï¼ˆæ–°è¡¨ï¼‰
```

#### åªéœ€ä¿®æ”¹è·¯ç”±è¡¨ï¼š
```sql
UPDATE d_sharding_route_mapping
SET physical_table_suffix = 6
WHERE logical_shard_id >= 320 AND logical_shard_id <= 383;
```

#### ä¼˜åŠ¿ï¼š
+ âœ… ä¸éœ€è¦ä¿®æ”¹ä»£ç 
+ âœ… ä¸éœ€è¦é‡å¯æœåŠ¡
+ âœ… ç§’çº§åˆ‡æ¢
+ âœ… å¯ä»¥å›žæ»š



