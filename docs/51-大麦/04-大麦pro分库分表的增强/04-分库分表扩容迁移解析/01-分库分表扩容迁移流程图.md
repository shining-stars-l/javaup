---
slug: /damai/damai-pro/sharding/virtual/expand/flow
sidebar_class_name: has-upgrade-badge
---

# åˆ†åº“åˆ†è¡¨æ‰©å®¹è¿ç§»æµç¨‹å›¾
æ­¤ç« èŠ‚æ˜¯å°†æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œå¦‚ä½•å°†æ•°æ®è¿ç§»æ–°è¡¨ã€æ›´æ–°è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±è¡¨ã€æ¸…é™¤æ—§è¡¨æ•°æ®çš„æ¯ä¸ªæ­¥éª¤æ•´ç†æˆäº†æµç¨‹å›¾ä¸­

âš ï¸**æ ¸å¿ƒç­–ç•¥è¯´æ˜ï¼š**  
æœ¬æ‰©å®¹æ–¹æ¡ˆä½¿ç”¨ **ç”¨æˆ·ID** è€Œéè®¢å•å·æ¥è®¡ç®—è™šæ‹Ÿåˆ†ç‰‡IDï¼Œç¡®ä¿åŒä¸€ç”¨æˆ·çš„æ‰€æœ‰è®¢å•ä¿æŒåœ¨åŒä¸€å¼ è¡¨ä¸­ã€‚

åŸå› ï¼š

+ è®¢å•å·è™½ç„¶åŒ…å«ç”¨æˆ·IDåŸºå› ä½ï¼Œä½† `orderNumber % 128 â‰  userId % 128`
+ å¦‚æœæŒ‰è®¢å•å·åˆ¤æ–­ï¼ŒåŒä¸€ç”¨æˆ·çš„è®¢å•ä¼šè¢«åˆ†æ•£åˆ°ä¸åŒè¡¨
+ ä½¿ç”¨ç”¨æˆ·IDåˆ¤æ–­ï¼Œä¿è¯æ•°æ®èšåˆæ€§å’ŒæŸ¥è¯¢æ€§èƒ½

å…³äºæ¯ä¸ªæ­¥éª¤çš„ä»£ç ä»¥åŠè¯¦ç»†è®²è§£ï¼Œå¯ä»¥è·³è½¬åˆ°ï¼š[è™šæ‹Ÿåˆ†ç‰‡çš„åˆ†åº“åˆ†è¡¨æ‰©å®¹æµç¨‹è§£æ](/damai/damai-pro/sharding/virtual/expand/analyse)

### 1. æ€»ä½“æµç¨‹å›¾
```mermaid
flowchart TD
    Start([å¼€å§‹æ‰©å®¹<br/>executeExpansion]) --> Step1([å‡†å¤‡é˜¶æ®µ<br/>æ‰‹åŠ¨åˆ›å»ºæ–°è¡¨])
    Step1 --> Step2([è¿ç§» damai_order_0 åº“])
    Step2 --> Step3([è¿ç§» damai_order_1 åº“])
    Step3 --> End([æ‰©å®¹å®Œæˆ])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style End fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Step1 fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Step2 fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
    style Step3 fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
```

### 2. å•åº“è¿ç§»æµç¨‹
```mermaid
flowchart TD
    Start([migrateDatabase<br/>å¼€å§‹è¿ç§»å•ä¸ªåº“]) --> CalcOffset([è®¡ç®—è™šæ‹Ÿåˆ†ç‰‡åŸºç¡€åç§»é‡<br/>damai_order_0 â†’ 0<br/>damai_order_1 â†’ 512])
    
    CalcOffset --> Table1([è¿ç§» d_order_0 â†’ d_order_4<br/>è™šæ‹Ÿåˆ†ç‰‡ 64-127])
    CalcOffset --> Table2([è¿ç§» d_order_1 â†’ d_order_5<br/>è™šæ‹Ÿåˆ†ç‰‡ 192-255])
    CalcOffset --> Table3([è¿ç§» d_order_2 â†’ d_order_6<br/>è™šæ‹Ÿåˆ†ç‰‡ 320-383])
    CalcOffset --> Table4([è¿ç§» d_order_3 â†’ d_order_7<br/>è™šæ‹Ÿåˆ†ç‰‡ 448-511])
    
    Table1 --> Check1{è¿ç§»æˆåŠŸ?}
    Table2 --> Check2{è¿ç§»æˆåŠŸ?}
    Table3 --> Check3{è¿ç§»æˆåŠŸ?}
    Table4 --> Check4{è¿ç§»æˆåŠŸ?}
    
    Check1 -->|æ˜¯| Table2
    Check2 -->|æ˜¯| Table3
    Check3 -->|æ˜¯| Table4
    Check4 -->|æ˜¯| Success([åº“è¿ç§»å®Œæˆ<br/>4è¡¨â†’8è¡¨])
    
    Check1 -->|å¦| Rollback1([å›æ»šè·¯ç”±è¡¨])
    Check2 -->|å¦| Rollback2([å›æ»šè·¯ç”±è¡¨])
    Check3 -->|å¦| Rollback3([å›æ»šè·¯ç”±è¡¨])
    Check4 -->|å¦| Rollback4([å›æ»šè·¯ç”±è¡¨])
    
    Rollback1 --> Fail([è¿ç§»å¤±è´¥])
    Rollback2 --> Fail
    Rollback3 --> Fail
    Rollback4 --> Fail
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Fail fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#b71c1c
    style CalcOffset fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Table1 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Table2 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Table3 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Table4 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Rollback1 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style Rollback2 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style Rollback3 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style Rollback4 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
```

### 3. å•è¡¨è¿ç§»è¯¦ç»†æµç¨‹
```mermaid
flowchart TD
    Start([migrateSingleTable<br/>å¼€å§‹è¿ç§»å•å¼ è¡¨]) --> Step1([è°ƒç”¨ migrateVirtualShardRange<br/>æ‰§è¡Œå®Œæ•´è¿ç§»æµç¨‹])
    
    Step1 --> Step2{è¿ç§»æˆåŠŸ?}
    
    Step2 -->|æ˜¯| Step3([è°ƒç”¨ cleanupSourceTableData<br/>æ¸…ç†æºè¡¨æ•°æ®])
    Step3 --> Success([å•è¡¨è¿ç§»å®Œæˆ])
    
    Step2 -->|å¦| Step4([æ•è·å¼‚å¸¸])
    Step4 --> Step5([è°ƒç”¨ rollbackMigration<br/>å›æ»šè·¯ç”±è¡¨])
    Step5 --> Fail([æŠ›å‡ºå¼‚å¸¸<br/>è¿ç§»å¤±è´¥])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Fail fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#b71c1c
    style Step1 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Step3 fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Step4 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style Step5 fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
```

### 4. å®Œæ•´è¿ç§»æµç¨‹ï¼ˆæ ¸å¿ƒï¼‰
```mermaid
flowchart TD
    Start([migrateVirtualShardRange<br/>å®Œæ•´è¿ç§»æµç¨‹]) --> Phase1([é˜¶æ®µ1: æ•°æ®è¿ç§»<br/>migrateTableData])
    
    Phase1 --> Phase1Detail([åˆ†æ‰¹æŸ¥è¯¢æºè¡¨<br/>âš ï¸ åŸºäºç”¨æˆ·IDè¿‡æ»¤è™šæ‹Ÿåˆ†ç‰‡<br/>æ’å…¥ç›®æ ‡è¡¨])
    
    Phase1Detail --> Phase2([é˜¶æ®µ2: æ›´æ–°è·¯ç”±è¡¨<br/>æ‰¹é‡ UPDATE])
    
    Phase2 --> Phase2Detail(["UPDATE d_sharding_route_mapping<br/>SET physical_table_suffix = ç›®æ ‡è¡¨<br/>WHERE logical_shard_id BETWEEN èµ·å§‹ AND ç»“æŸ"])
    
    Phase2Detail --> Phase3([é˜¶æ®µ3: åˆ·æ–°ç¼“å­˜<br/>æ¸…ç©ºè·¯ç”±ç¼“å­˜])
    
    Phase3 --> Success([è¿ç§»å®Œæˆ<br/>æµé‡å·²åˆ‡æ¢åˆ°æ–°è¡¨])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Phase1 fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Phase2 fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#880e4f
    style Phase3 fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Phase1Detail fill:#e3f2fd,stroke:#42a5f5,stroke-width:2px,color:#1565c0
    style Phase2Detail fill:#fce4ec,stroke:#ec407a,stroke-width:2px,color:#ad1457
```

### 5. æ•°æ®è¿ç§»è¯¦ç»†æµç¨‹
```mermaid
flowchart TD
    Start([migrateTableData<br/>å¼€å§‹æ•°æ®è¿ç§»]) --> Init([åˆå§‹åŒ–<br/>pageSize=1000<br/>lastId=0<br/>totalMigrated=0])
    
    Init --> Loop{å¼€å§‹å¾ªç¯}
    
    Loop --> Query([ä½¿ç”¨ HintManager<br/>å¼ºåˆ¶è·¯ç”±åˆ°æºè¡¨<br/>æŸ¥è¯¢1000æ¡æ•°æ®])
    
    Query --> Check{æ•°æ®ä¸ºç©º?}
    
    Check -->|æ˜¯| EndLoop([æŸ¥è¯¢å®Œæ¯•<br/>é€€å‡ºå¾ªç¯])
    
    Check -->|å¦| Filter([è¿‡æ»¤æ•°æ®<br/>âš ï¸ ç”¨ç”¨æˆ·IDè®¡ç®—è™šæ‹Ÿåˆ†ç‰‡<br/>åˆ¤æ–­æ˜¯å¦éœ€è¦è¿ç§»])
    
    Filter --> Insert([ä½¿ç”¨ HintManager<br/>å¼ºåˆ¶è·¯ç”±åˆ°ç›®æ ‡è¡¨<br/>æ‰¹é‡æ’å…¥æ•°æ®])
    
    Insert --> UpdateCursor([æ›´æ–°æ¸¸æ ‡<br/>lastId = æœ€åä¸€æ¡è®°å½•çš„ID])
    
    UpdateCursor --> Sleep([æ§åˆ¶é€Ÿåº¦<br/>æ¯10æ‰¹ä¼‘çœ 100ms])
    
    Sleep --> Loop
    
    EndLoop --> Success([æ•°æ®è¿ç§»å®Œæˆ<br/>è¿”å›è¿ç§»æ•°é‡])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Init fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style EndLoop fill:#c8e6c9,stroke:#66bb6a,stroke-width:2px,color:#2e7d32
    style Query fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Filter fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Insert fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#880e4f
    style UpdateCursor fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
    style Sleep fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
```

### 6. HintManager å¼ºåˆ¶è·¯ç”±æœºåˆ¶
```mermaid
flowchart LR
    Start([å¼€å§‹æŸ¥è¯¢]) --> HintManager([åˆ›å»º HintManager<br/>try-with-resources])
    
    HintManager --> SetDB([è®¾ç½®æ•°æ®æºåç¼€<br/>addDatabaseShardingValue<br/>é€»è¾‘è¡¨: d_order<br/>åº“åç¼€: 0])
    
    SetDB --> SetTable([è®¾ç½®è¡¨åç¼€<br/>addTableShardingValue<br/>é€»è¾‘è¡¨: d_order<br/>è¡¨åç¼€: 0])
    
    SetTable --> Query([æ‰§è¡ŒæŸ¥è¯¢<br/>orderMapper.selectList])
    
    Query --> Route([ShardingSphere è·¯ç”±<br/>è¯»å– ThreadLocal ä¸­çš„ Hint ä¿¡æ¯<br/>å¼ºåˆ¶è·¯ç”±åˆ°æŒ‡å®šç‰©ç†è¡¨])
    
    Route --> Target[(damai_order_0.d_order_0<br/>ç›®æ ‡ç‰©ç†è¡¨)]
    
    Target --> Close([è‡ªåŠ¨å…³é—­ HintManager<br/>æ¸…ç† ThreadLocal])
    
    Close --> End([æŸ¥è¯¢å®Œæˆ])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style End fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style HintManager fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style SetDB fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style SetTable fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Query fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Route fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#880e4f
    style Target fill:#e1bee7,stroke:#7b1fa2,stroke-width:3px,color:#6a1b9a
    style Close fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
```

### 7. è™šæ‹Ÿåˆ†ç‰‡è·¯ç”±åŸç†
```mermaid
flowchart TD
    Start([è®¢å•å·æŸ¥è¯¢è¯·æ±‚]) --> Calc([è®¡ç®—è™šæ‹Ÿåˆ†ç‰‡ID<br/>hashè®¢å•å· % 1024])
    
    Calc --> Example([ç¤ºä¾‹:<br/>è®¢å•å·: 202501010001<br/>è™šæ‹Ÿåˆ†ç‰‡ID: 125])
    
    Example --> QueryRoute([æŸ¥è¯¢è·¯ç”±è¡¨<br/>SELECT * FROM d_sharding_route_mapping<br/>WHERE logical_shard_id = 125])
    
    QueryRoute --> RouteResult([è·¯ç”±ç»“æœ:<br/>physical_database_suffix = 0<br/>physical_table_suffix = 4])
    
    RouteResult --> Target([ç›®æ ‡ç‰©ç†è¡¨:<br/>damai_order_0.d_order_4])
    
    Target --> Execute([æ‰§è¡ŒæŸ¥è¯¢<br/>SELECT * FROM damai_order_0.d_order_4<br/>WHERE order_number = '202501010001'])
    
    Execute --> Return([è¿”å›ç»“æœ])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Return fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Calc fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Example fill:#e3f2fd,stroke:#42a5f5,stroke-width:2px,color:#1565c0
    style QueryRoute fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#880e4f
    style RouteResult fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Target fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Execute fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
```

### 8. è·¯ç”±è¡¨æ›´æ–°è¿‡ç¨‹
```mermaid
flowchart TD
    Start([å¼€å§‹æ›´æ–°è·¯ç”±è¡¨]) --> Before([æ›´æ–°å‰çŠ¶æ€:<br/>è™šæ‹Ÿåˆ†ç‰‡ 64-127<br/>â†’ damai_order_0.d_order_0])
    
    Before --> UpdateSQL(["æ‰§è¡Œ SQL:<br/>UPDATE d_sharding_route_mapping<br/>SET physical_table_suffix = 4,<br/>    version = version + 1<br/>WHERE logical_shard_id BETWEEN 64 AND 127"])
    
    UpdateSQL --> After([æ›´æ–°åçŠ¶æ€:<br/>è™šæ‹Ÿåˆ†ç‰‡ 64-127<br/>â†’ damai_order_0.d_order_4])
    
    After --> Traffic([æ–°æµé‡åˆ‡æ¢:<br/>æ‰€æœ‰æŸ¥è¯¢è™šæ‹Ÿåˆ†ç‰‡64-127çš„è¯·æ±‚<br/>ç«‹å³è·¯ç”±åˆ°æ–°è¡¨ d_order_4])
    
    Traffic --> Success([è·¯ç”±åˆ‡æ¢å®Œæˆ<br/>æ¯«ç§’çº§å®Œæˆ])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Before fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style After fill:#c8e6c9,stroke:#66bb6a,stroke-width:2px,color:#2e7d32
    style UpdateSQL fill:#f8bbd0,stroke:#c2185b,stroke-width:3px,color:#880e4f
    style Traffic fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
```

### 9. æ•°æ®æ¸…ç†æµç¨‹
```mermaid
flowchart TD
    Start([cleanupSourceTableData<br/>å¼€å§‹æ¸…ç†æºè¡¨]) --> Init([åˆå§‹åŒ–<br/>pageSize=1000<br/>lastId=0<br/>totalDeleted=0])
    
    Init --> Loop{å¼€å§‹å¾ªç¯}
    
    Loop --> Query([ä½¿ç”¨ HintManager<br/>å¼ºåˆ¶è·¯ç”±åˆ°æºè¡¨<br/>æŸ¥è¯¢1000æ¡æ•°æ®])
    
    Query --> Check{æ•°æ®ä¸ºç©º?}
    
    Check -->|æ˜¯| EndLoop([æ¸…ç†å®Œæ¯•<br/>é€€å‡ºå¾ªç¯])
    
    Check -->|å¦| Filter([è¿‡æ»¤æ•°æ®<br/>âš ï¸ ç”¨ç”¨æˆ·IDè®¡ç®—è™šæ‹Ÿåˆ†ç‰‡<br/>åˆ¤æ–­æ˜¯å¦éœ€è¦åˆ é™¤])
    
    Filter --> Delete([ä½¿ç”¨ HintManager<br/>å¼ºåˆ¶è·¯ç”±åˆ°æºè¡¨<br/>æ‰¹é‡ç‰©ç†åˆ é™¤])
    
    Delete --> UpdateCursor([æ›´æ–°æ¸¸æ ‡<br/>lastId = æœ€åä¸€æ¡è®°å½•çš„ID])
    
    UpdateCursor --> Sleep([æ§åˆ¶é€Ÿåº¦<br/>æ¯10æ‰¹ä¼‘çœ 100ms])
    
    Sleep --> Loop
    
    EndLoop --> Success([æ•°æ®æ¸…ç†å®Œæˆ<br/>è¿”å›åˆ é™¤æ•°é‡])
    
    style Start fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style Success fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style Init fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style EndLoop fill:#c8e6c9,stroke:#66bb6a,stroke-width:2px,color:#2e7d32
    style Query fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style Filter fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Delete fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style UpdateCursor fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
    style Sleep fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
```

### 10. å¼‚å¸¸å›æ»šæµç¨‹
```mermaid
flowchart TD
    Start([æ£€æµ‹åˆ°å¼‚å¸¸]) --> CatchError([æ•è·å¼‚å¸¸<br/>Exception e])
    
    CatchError --> LogError([è®°å½•é”™è¯¯æ—¥å¿—<br/>è¿ç§»å¤±è´¥åŸå› ])
    
    LogError --> Rollback([è°ƒç”¨ rollbackMigration<br/>å›æ»šè·¯ç”±è¡¨])
    
    Rollback --> UpdateSQL(["æ‰§è¡Œå›æ»š SQL:<br/>UPDATE d_sharding_route_mapping<br/>SET physical_table_suffix = åŸå§‹è¡¨åç¼€,<br/>    version = version + 1<br/>WHERE logical_shard_id BETWEEN èµ·å§‹ AND ç»“æŸ"])
    
    UpdateSQL --> RefreshCache([åˆ·æ–°ç¼“å­˜<br/>æ¸…é™¤è·¯ç”±ç¼“å­˜])
    
    RefreshCache --> Result([å›æ»šç»“æœ:<br/>æµé‡æ¢å¤åˆ°åŸè¡¨<br/>ä¸šåŠ¡ä¸å—å½±å“])
    
    Result --> Cleanup([æ¸…ç†å»ºè®®:<br/>å¯ä»¥åˆ é™¤æ–°è¡¨ä¸­çš„è¿ç§»æ•°æ®<br/>å‡†å¤‡é‡æ–°æ‰§è¡Œ])
    
    Cleanup --> End([å›æ»šå®Œæˆ])
    
    style Start fill:#ffcdd2,stroke:#c62828,stroke-width:3px,color:#b71c1c
    style End fill:#ffe0b2,stroke:#f57c00,stroke-width:3px,color:#e65100
    style CatchError fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style LogError fill:#ffccbc,stroke:#d84315,stroke-width:2px,color:#bf360c
    style Rollback fill:#ffccbc,stroke:#d84315,stroke-width:3px,color:#bf360c
    style UpdateSQL fill:#f8bbd0,stroke:#c2185b,stroke-width:2px,color:#880e4f
    style RefreshCache fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style Result fill:#c8e6c9,stroke:#66bb6a,stroke-width:2px,color:#2e7d32
    style Cleanup fill:#ffe0b2,stroke:#f57c00,stroke-width:2px,color:#e65100
```

### 11. å®Œæ•´æ‰©å®¹æ—¶åºå›¾
```mermaid
%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#d4e6ff','primaryTextColor':'#1a4d99','primaryBorderColor':'#1a4d99','lineColor':'#2c73d2','secondaryColor':'#ffd4e0','secondaryTextColor':'#cc1f4d','secondaryBorderColor':'#ff4573','tertiaryColor':'#ffe8ee','tertiaryTextColor':'#cc1f4d','tertiaryBorderColor':'#ff4573','noteBkgColor':'#ffd4e0','noteTextColor':'#cc1f4d','noteBorderColor':'#ff4573','actorBkg':'#d4e6ff','actorBorder':'#1a4d99','actorTextColor':'#1a4d99','actorLineColor':'#2c73d2','signalColor':'#2c73d2','signalTextColor':'#1a4d99','labelBoxBkgColor':'#ffd4e0','labelBoxBorderColor':'#ff4573','labelTextColor':'#cc1f4d','loopTextColor':'#cc1f4d','activationBorderColor':'#1a4d99','activationBkgColor':'#d4e6ff','sequenceNumberColor':'#ffffff'}}}%%
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Service as ShardingExpansionService
    participant Task as VirtualShardMigrationTask
    participant Mapper as OrderMapper
    participant DB as æ•°æ®åº“
    participant RouteDB as è·¯ç”±è¡¨
    
    Client->>Service: executeExpansion()
    activate Service
    
    Note over Service: ç¬¬1æ­¥ï¼šå‡†å¤‡é˜¶æ®µï¼ˆæ‰‹åŠ¨åˆ›å»ºæ–°è¡¨ï¼‰
    
    Service->>Service: migrateDatabase("damai_order_0")
    activate Service
    
    Service->>Service: migrateSingleTable(d_order_0â†’d_order_4)
    activate Service
    
    Service->>Task: migrateVirtualShardRange(64-127)
    activate Task
    
    Note over Task: é˜¶æ®µ1ï¼šæ•°æ®è¿ç§»
    Task->>Task: migrateTableData()
    activate Task
    
    loop åˆ†æ‰¹è¿ç§»
        Task->>Mapper: HintManager + selectList(æºè¡¨)
        Mapper->>DB: æŸ¥è¯¢ damai_order_0.d_order_0
        DB-->>Mapper: è¿”å›1000æ¡æ•°æ®
        Mapper-->>Task: è¿”å›è®¢å•åˆ—è¡¨
        
        Task->>Task: âš ï¸ åŸºäºç”¨æˆ·IDè¿‡æ»¤è™šæ‹Ÿåˆ†ç‰‡64-127
        
        Task->>Mapper: HintManager + insert(ç›®æ ‡è¡¨)
        Mapper->>DB: æ’å…¥ damai_order_0.d_order_4
        DB-->>Mapper: æ’å…¥æˆåŠŸ
        Mapper-->>Task: è¿”å›æ’å…¥æ•°é‡
    end
    
    Task-->>Task: æ•°æ®è¿ç§»å®Œæˆ
    deactivate Task
    
    Note over Task: é˜¶æ®µ2ï¼šæ›´æ–°è·¯ç”±è¡¨ï¼ˆå…³é”®ï¼‰
    Task->>RouteDB: UPDATE è™šæ‹Ÿåˆ†ç‰‡64-127è·¯ç”±â†’d_order_4
    RouteDB-->>Task: æ›´æ–°64æ¡è®°å½•
    
    Note over Task: é˜¶æ®µ3ï¼šåˆ·æ–°ç¼“å­˜
    Task->>Task: æ¸…ç©ºè·¯ç”±ç¼“å­˜
    
    Task-->>Service: è¿”å›è¿ç§»æ•°é‡
    deactivate Task
    
    Note over Service: æ•°æ®æ¸…ç†
    Service->>Task: cleanupSourceTableData(æºè¡¨, 64-127)
    activate Task
    
    loop åˆ†æ‰¹åˆ é™¤
        Task->>Mapper: HintManager + selectList(æºè¡¨)
        Mapper->>DB: æŸ¥è¯¢ damai_order_0.d_order_0
        DB-->>Mapper: è¿”å›1000æ¡æ•°æ®
        Mapper-->>Task: è¿”å›è®¢å•åˆ—è¡¨
        
        Task->>Task: âš ï¸ åŸºäºç”¨æˆ·IDè¿‡æ»¤è™šæ‹Ÿåˆ†ç‰‡64-127
        
        Task->>Mapper: HintManager + physicalDeleteByIds(æºè¡¨)
        Mapper->>DB: åˆ é™¤ damai_order_0.d_order_0
        DB-->>Mapper: åˆ é™¤æˆåŠŸ
        Mapper-->>Task: è¿”å›åˆ é™¤æ•°é‡
    end
    
    Task-->>Service: è¿”å›åˆ é™¤æ•°é‡
    deactivate Task
    
    Service-->>Service: d_order_0â†’d_order_4 è¿ç§»å®Œæˆ
    deactivate Service
    
    Note over Service: é‡å¤ä»¥ä¸Šæµç¨‹ï¼Œè¿ç§»å…¶ä»–3å¼ è¡¨
    
    Service-->>Service: damai_order_0 åº“è¿ç§»å®Œæˆ
    deactivate Service
    
    Note over Service: é‡å¤ä»¥ä¸Šæµç¨‹ï¼Œè¿ç§» damai_order_1 åº“
    
    Service-->>Client: æ‰©å®¹å®Œæˆ
    deactivate Service
```

### 12. è™šæ‹Ÿåˆ†ç‰‡åˆ†é…å›¾
```mermaid
graph TB
    subgraph "æ‰©å®¹å‰ï¼š8å¼ è¡¨ï¼Œæ¯å¼ 128ä¸ªè™šæ‹Ÿåˆ†ç‰‡"
        DB0_Before([damai_order_0])
        DB1_Before([damai_order_1])
        
        T0_Before([d_order_0<br/>è™šæ‹Ÿåˆ†ç‰‡ 0-127])
        T1_Before([d_order_1<br/>è™šæ‹Ÿåˆ†ç‰‡ 128-255])
        T2_Before([d_order_2<br/>è™šæ‹Ÿåˆ†ç‰‡ 256-383])
        T3_Before([d_order_3<br/>è™šæ‹Ÿåˆ†ç‰‡ 384-511])
        
        T4_Before([d_order_0<br/>è™šæ‹Ÿåˆ†ç‰‡ 512-639])
        T5_Before([d_order_1<br/>è™šæ‹Ÿåˆ†ç‰‡ 640-767])
        T6_Before([d_order_2<br/>è™šæ‹Ÿåˆ†ç‰‡ 768-895])
        T7_Before([d_order_3<br/>è™šæ‹Ÿåˆ†ç‰‡ 896-1023])
        
        DB0_Before --> T0_Before
        DB0_Before --> T1_Before
        DB0_Before --> T2_Before
        DB0_Before --> T3_Before
        
        DB1_Before --> T4_Before
        DB1_Before --> T5_Before
        DB1_Before --> T6_Before
        DB1_Before --> T7_Before
    end
    
    subgraph "æ‰©å®¹åï¼š16å¼ è¡¨ï¼Œæ¯å¼ 64ä¸ªè™šæ‹Ÿåˆ†ç‰‡"
        DB0_After([damai_order_0])
        DB1_After([damai_order_1])
        
        T0_After([d_order_0<br/>è™šæ‹Ÿåˆ†ç‰‡ 0-63])
        T0_New([d_order_4<br/>è™šæ‹Ÿåˆ†ç‰‡ 64-127 âœ¨])
        
        T1_After([d_order_1<br/>è™šæ‹Ÿåˆ†ç‰‡ 128-191])
        T1_New([d_order_5<br/>è™šæ‹Ÿåˆ†ç‰‡ 192-255 âœ¨])
        
        T2_After([d_order_2<br/>è™šæ‹Ÿåˆ†ç‰‡ 256-319])
        T2_New([d_order_6<br/>è™šæ‹Ÿåˆ†ç‰‡ 320-383 âœ¨])
        
        T3_After([d_order_3<br/>è™šæ‹Ÿåˆ†ç‰‡ 384-447])
        T3_New([d_order_7<br/>è™šæ‹Ÿåˆ†ç‰‡ 448-511 âœ¨])
        
        T4_After([d_order_0<br/>è™šæ‹Ÿåˆ†ç‰‡ 512-575])
        T4_New([d_order_4<br/>è™šæ‹Ÿåˆ†ç‰‡ 576-639 âœ¨])
        
        T5_After([d_order_1<br/>è™šæ‹Ÿåˆ†ç‰‡ 640-703])
        T5_New([d_order_5<br/>è™šæ‹Ÿåˆ†ç‰‡ 704-767 âœ¨])
        
        T6_After([d_order_2<br/>è™šæ‹Ÿåˆ†ç‰‡ 768-831])
        T6_New([d_order_6<br/>è™šæ‹Ÿåˆ†ç‰‡ 832-895 âœ¨])
        
        T7_After([d_order_3<br/>è™šæ‹Ÿåˆ†ç‰‡ 896-959])
        T7_New([d_order_7<br/>è™šæ‹Ÿåˆ†ç‰‡ 960-1023 âœ¨])
        
        DB0_After --> T0_After
        DB0_After --> T0_New
        DB0_After --> T1_After
        DB0_After --> T1_New
        DB0_After --> T2_After
        DB0_After --> T2_New
        DB0_After --> T3_After
        DB0_After --> T3_New
        
        DB1_After --> T4_After
        DB1_After --> T4_New
        DB1_After --> T5_After
        DB1_After --> T5_New
        DB1_After --> T6_After
        DB1_After --> T6_New
        DB1_After --> T7_After
        DB1_After --> T7_New
    end
    
    style DB0_Before fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style DB1_Before fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style T0_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T1_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T2_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T3_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T4_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T5_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T6_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    style T7_Before fill:#bbdefb,stroke:#1976d2,stroke-width:2px,color:#0d47a1
    
    style DB0_After fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style DB1_After fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#1565c0
    style T0_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T1_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T2_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T3_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T4_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T5_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T6_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T7_After fill:#e1bee7,stroke:#7b1fa2,stroke-width:2px,color:#6a1b9a
    style T0_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T1_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T2_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T3_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T4_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T5_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T6_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
    style T7_New fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#2e7d32
```

### é¢œè‰²è¯´æ˜
+ ğŸ”µ **æµ…è“è‰² (#e3f2fd)**ï¼šå¼€å§‹èŠ‚ç‚¹ã€è¾“å…¥èŠ‚ç‚¹
+ ğŸŸ¢ **æµ…ç»¿è‰² (#c8e6c9)**ï¼šæˆåŠŸèŠ‚ç‚¹ã€å®ŒæˆèŠ‚ç‚¹
+ ğŸ”´ **æµ…çº¢è‰² (#ffcdd2)**ï¼šå¤±è´¥èŠ‚ç‚¹ã€å¼‚å¸¸èŠ‚ç‚¹
+ ğŸŸ£ **æµ…ç´«è‰² (#f3e5f5, #e1bee7)**ï¼šåˆå§‹åŒ–èŠ‚ç‚¹ã€å¤„ç†èŠ‚ç‚¹ã€è®¡ç®—èŠ‚ç‚¹
+ ğŸ”µ **è“è‰² (#bbdefb)**ï¼šæŸ¥è¯¢æ“ä½œã€æ•°æ®åº“è¯»å–
+ ğŸŒ¸ **ç²‰è‰² (#f8bbd0, #fce4ec)**ï¼šæ•°æ®æ’å…¥ã€è·¯ç”±æ›´æ–°
+ ğŸŸ  **æµ…æ©™è‰² (#ffe0b2)**ï¼šæ¸¸æ ‡æ›´æ–°ã€æ§åˆ¶èŠ‚ç‚¹
+ ğŸ”´ **æ©™çº¢è‰² (#ffccbc)**ï¼šåˆ é™¤æ“ä½œã€å›æ»šèŠ‚ç‚¹

