---
slug: /damai/damai-pro/sharding/virtual/script
---

import PaidCTA from '@site/src/components/PaidCTA';

# 虚拟分片扩容测试数据生成脚本

## 一、脚本说明
### 1.1 目的
生成符合基因法规则的测试数据，用于验证 **基于用户ID维度的** 虚拟分片扩容方案的正确性。

### 1.2 数据特点
+ **订单号生成**：遵循基因法，订单号的后3位嵌入用户ID的基因位
+ **数据分布**：确保数据均匀分布在8个物理分片（2库×4表）
+ **关联数据**：生成订单、购票人订单、订单记录三类关联数据
+ **用户维度**：同一用户的所有订单必须在同一张表（基于用户ID的虚拟分片ID）

### 1.3 生成数据量
+ 每个物理分片生成约1000条订单
+ 总计约8000条订单及对应的关联数据
+ 每个用户生成1-5个订单，测试同一用户多订单场景

## 二、复制脚本到数据库中
### 2.1 基因法订单号生成函数（复制此函数到数据库中执行）
```sql
-- =====================================================
-- 第一步：删除旧函数（如果存在）
-- =====================================================
DROP FUNCTION IF EXISTS generate_order_number_with_gene;

DELIMITER $$

-- =====================================================
-- 第二步：创建函数 - generate_order_number_with_gene
-- 功能：根据用户ID生成包含基因位的订单号
-- 参数：
--   p_user_id: 用户ID
--   p_sequence: 序列号（模拟雪花ID的序列部分）
-- 返回：订单编号（BIGINT）
-- =====================================================
CREATE FUNCTION generate_order_number_with_gene(
    p_user_id BIGINT,
    p_sequence INT
)
RETURNS BIGINT
DETERMINISTIC
BEGIN
    DECLARE v_gene_bits INT;
    DECLARE v_timestamp BIGINT;
    DECLARE v_order_number BIGINT;
    
    -- 1. 提取用户ID的后3位作为基因位（2库×4表=3位基因）
    SET v_gene_bits = p_user_id & 7;  -- 7 = 0b111
    
    -- 2. 生成时间戳部分（使用当前时间戳的秒数）
    SET v_timestamp = UNIX_TIMESTAMP();
    
    -- 3. 生成订单号
    -- 结构：[时间戳(40位)][序列号(21位)][基因(3位)]
    SET v_order_number = (v_timestamp << 24)     -- 时间戳左移24位
                       | (p_sequence << 3)        -- 序列号左移3位
                       | v_gene_bits;             -- 基因位（后3位）
    
    RETURN v_order_number;
END$$

DELIMITER ;
```

### 使用说明：
1. **创建函数**：复制上面的SQL代码，在MySQL客户端执行，会自动删除旧函数并创建新函数
2. **测试函数**：

```sql
-- 测试订单号生成
SELECT generate_order_number_with_gene(1136344580112367618, 1) AS order_number;
```

### 2.2 计算虚拟分片ID函数（复制此函数到数据库中执行）

<PaidCTA />