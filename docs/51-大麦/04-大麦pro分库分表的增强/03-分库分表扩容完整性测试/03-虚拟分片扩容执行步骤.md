---
slug: /damai/damai-pro/sharding/virtual/expand
---

# è™šæ‹Ÿåˆ†ç‰‡æ‰©å®¹æ‰§è¡Œæ­¥éª¤

## ä¸€ã€æ‰§è¡Œæ‰©å®¹
### 1.1 åˆ›å»ºæ–°è¡¨
```sql
-- åœ¨ damai_order_0 åº“åˆ›å»ºæ–°è¡¨
USE damai_order_0;
DROP TABLE IF EXISTS `d_order_4`;
CREATE TABLE d_order_4 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_5`;
CREATE TABLE d_order_5 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_6`;
CREATE TABLE d_order_6 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_7`;
CREATE TABLE d_order_7 LIKE d_order_0;

-- åœ¨ damai_order_1 åº“åˆ›å»ºæ–°è¡¨
USE damai_order_1;
DROP TABLE IF EXISTS `d_order_4`;
CREATE TABLE d_order_4 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_5`;
CREATE TABLE d_order_5 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_6`;
CREATE TABLE d_order_6 LIKE d_order_0;
DROP TABLE IF EXISTS `d_order_7`;
CREATE TABLE d_order_7 LIKE d_order_0;
```

### 1.2 æ‰§è¡Œæ‰©å®¹è¿ç§»
+ å…ˆå¯åŠ¨ `migrate-service` æœåŠ¡
+ è°ƒç”¨æ‰©å®¹è¿ç§»æ¥å£ï¼š

```java
http://127.0.0.1:6085/damai/migrate/order/data/virtual/expand
```

### è¿ç§»è§„åˆ™ï¼ˆåŸºäºç”¨æˆ·IDï¼‰ï¼š
```plain
ç”¨æˆ·IDè™šæ‹Ÿåˆ†ç‰‡64-127çš„æ‰€æœ‰è®¢å• â†’ è¿ç§»åˆ° d_order_4
ç”¨æˆ·IDè™šæ‹Ÿåˆ†ç‰‡192-255çš„æ‰€æœ‰è®¢å• â†’ è¿ç§»åˆ° d_order_5
ç”¨æˆ·IDè™šæ‹Ÿåˆ†ç‰‡320-383çš„æ‰€æœ‰è®¢å• â†’ è¿ç§»åˆ° d_order_6
ç”¨æˆ·IDè™šæ‹Ÿåˆ†ç‰‡448-511çš„æ‰€æœ‰è®¢å• â†’ è¿ç§»åˆ° d_order_7
```

## äºŒã€æ•°æ®éªŒè¯ï¼ˆæ‰©å®¹åï¼‰
### 2.1 éªŒè¯æ•°æ®åˆ†å¸ƒå‡åŒ€æ€§
å¿«é€ŸæŸ¥çœ‹16å¼ è¡¨çš„æ•°æ®é‡ï¼š

```sql
SELECT 'åº“0-è¡¨0' AS è¡¨å, COUNT(*) AS æ•°æ®é‡ FROM damai_order_0.d_order_0
UNION ALL SELECT 'åº“0-è¡¨1', COUNT(*) FROM damai_order_0.d_order_1
UNION ALL SELECT 'åº“0-è¡¨2', COUNT(*) FROM damai_order_0.d_order_2
UNION ALL SELECT 'åº“0-è¡¨3', COUNT(*) FROM damai_order_0.d_order_3
UNION ALL SELECT 'åº“0-è¡¨4', COUNT(*) FROM damai_order_0.d_order_4
UNION ALL SELECT 'åº“0-è¡¨5', COUNT(*) FROM damai_order_0.d_order_5
UNION ALL SELECT 'åº“0-è¡¨6', COUNT(*) FROM damai_order_0.d_order_6
UNION ALL SELECT 'åº“0-è¡¨7', COUNT(*) FROM damai_order_0.d_order_7
UNION ALL SELECT 'åº“1-è¡¨0', COUNT(*) FROM damai_order_1.d_order_0
UNION ALL SELECT 'åº“1-è¡¨1', COUNT(*) FROM damai_order_1.d_order_1
UNION ALL SELECT 'åº“1-è¡¨2', COUNT(*) FROM damai_order_1.d_order_2
UNION ALL SELECT 'åº“1-è¡¨3', COUNT(*) FROM damai_order_1.d_order_3
UNION ALL SELECT 'åº“1-è¡¨4', COUNT(*) FROM damai_order_1.d_order_4
UNION ALL SELECT 'åº“1-è¡¨5', COUNT(*) FROM damai_order_1.d_order_5
UNION ALL SELECT 'åº“1-è¡¨6', COUNT(*) FROM damai_order_1.d_order_6
UNION ALL SELECT 'åº“1-è¡¨7', COUNT(*) FROM damai_order_1.d_order_7;
```

### é¢„æœŸç»“æœï¼š
+ æ¯å¼ è¡¨çº¦6.25%ï¼ˆ1/16ï¼‰
+ æ•°æ®é‡åå·®ä¸è¶…è¿‡Â±10%ä¸ºæ­£å¸¸

### 2.2 â­ æ ¸å¿ƒéªŒè¯ï¼šåŒä¸€ç”¨æˆ·è®¢å•ä¸€è‡´æ€§
```sql
-- éªŒè¯æ‰©å®¹åï¼ŒåŒä¸€ç”¨æˆ·çš„æ‰€æœ‰è®¢å•æ˜¯å¦ä»åœ¨åŒä¸€å¼ è¡¨
-- è¿™æ˜¯éªŒè¯æ–°è¿ç§»é€»è¾‘æ˜¯å¦æ­£ç¡®çš„å…³é”®

SELECT 
    'ğŸ” ç”¨æˆ·è®¢å•ä¸€è‡´æ€§éªŒè¯ï¼ˆæ‰©å®¹åï¼‰' AS éªŒè¯é¡¹,
    CASE 
        WHEN inconsistent_count = 0 THEN 'âœ… å®Œç¾ï¼æ‰€æœ‰ç”¨æˆ·çš„è®¢å•éƒ½åœ¨åŒä¸€å¼ è¡¨'
        WHEN inconsistent_count <= total_users * 0.01 THEN 'âš ï¸  æœ‰å°‘é‡ç”¨æˆ·è®¢å•åˆ†æ•£'
        ELSE 'âŒ ä¸¥é‡é—®é¢˜ï¼å¤§é‡ç”¨æˆ·è®¢å•åˆ†æ•£'
    END AS éªŒè¯ç»“æœ,
    total_users AS æ€»ç”¨æˆ·æ•°,
    inconsistent_count AS è®¢å•åˆ†æ•£çš„ç”¨æˆ·æ•°,
    CONCAT(ROUND(inconsistent_count * 100.0 / total_users, 2), '%') AS é—®é¢˜æ¯”ç‡
FROM (
    SELECT 
        COUNT(DISTINCT user_id) AS total_users,
        SUM(CASE WHEN table_count > 1 THEN 1 ELSE 0 END) AS inconsistent_count
    FROM (
        SELECT 
            user_id,
            COUNT(DISTINCT CONCAT(database_name, '.', table_name)) AS table_count
        FROM (
            SELECT user_id, 'damai_order_0' AS database_name, 'd_order_0' AS table_name FROM damai_order_0.d_order_0
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_1' FROM damai_order_0.d_order_1
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_2' FROM damai_order_0.d_order_2
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_3' FROM damai_order_0.d_order_3
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_4' FROM damai_order_0.d_order_4
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_5' FROM damai_order_0.d_order_5
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_6' FROM damai_order_0.d_order_6
            UNION ALL SELECT user_id, 'damai_order_0', 'd_order_7' FROM damai_order_0.d_order_7
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_0' FROM damai_order_1.d_order_0
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_1' FROM damai_order_1.d_order_1
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_2' FROM damai_order_1.d_order_2
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_3' FROM damai_order_1.d_order_3
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_4' FROM damai_order_1.d_order_4
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_5' FROM damai_order_1.d_order_5
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_6' FROM damai_order_1.d_order_6
            UNION ALL SELECT user_id, 'damai_order_1', 'd_order_7' FROM damai_order_1.d_order_7
        ) all_orders
        GROUP BY user_id
    ) user_table_count
) summary;

-- è¯¦ç»†ï¼šåˆ—å‡ºè®¢å•åˆ†æ•£çš„ç”¨æˆ·ï¼ˆå‰20ä¸ªï¼‰
SELECT 
    'âŒ è®¢å•åˆ†æ•£çš„ç”¨æˆ·æ˜ç»†' AS æ˜ç»†,
    user_id AS ç”¨æˆ·ID,
    GROUP_CONCAT(DISTINCT table_location ORDER BY table_location) AS è®¢å•åˆ†å¸ƒ,
    COUNT(DISTINCT table_location) AS è·¨è¡¨æ•°é‡,
    COUNT(*) AS è®¢å•æ€»æ•°
FROM (
    SELECT user_id, CONCAT('damai_order_0.d_order_0') AS table_location FROM damai_order_0.d_order_0
    UNION ALL SELECT user_id, 'damai_order_0.d_order_1' FROM damai_order_0.d_order_1
    UNION ALL SELECT user_id, 'damai_order_0.d_order_2' FROM damai_order_0.d_order_2
    UNION ALL SELECT user_id, 'damai_order_0.d_order_3' FROM damai_order_0.d_order_3
    UNION ALL SELECT user_id, 'damai_order_0.d_order_4' FROM damai_order_0.d_order_4
    UNION ALL SELECT user_id, 'damai_order_0.d_order_5' FROM damai_order_0.d_order_5
    UNION ALL SELECT user_id, 'damai_order_0.d_order_6' FROM damai_order_0.d_order_6
    UNION ALL SELECT user_id, 'damai_order_0.d_order_7' FROM damai_order_0.d_order_7
    UNION ALL SELECT user_id, 'damai_order_1.d_order_0' FROM damai_order_1.d_order_0
    UNION ALL SELECT user_id, 'damai_order_1.d_order_1' FROM damai_order_1.d_order_1
    UNION ALL SELECT user_id, 'damai_order_1.d_order_2' FROM damai_order_1.d_order_2
    UNION ALL SELECT user_id, 'damai_order_1.d_order_3' FROM damai_order_1.d_order_3
    UNION ALL SELECT user_id, 'damai_order_1.d_order_4' FROM damai_order_1.d_order_4
    UNION ALL SELECT user_id, 'damai_order_1.d_order_5' FROM damai_order_1.d_order_5
    UNION ALL SELECT user_id, 'damai_order_1.d_order_6' FROM damai_order_1.d_order_6
    UNION ALL SELECT user_id, 'damai_order_1.d_order_7' FROM damai_order_1.d_order_7
) all_orders
GROUP BY user_id
HAVING COUNT(DISTINCT table_location) > 1
LIMIT 20;
```

### 2.3 éªŒè¯æ‰©å®¹æˆåŠŸ
#### æ ¸å¿ƒæŒ‡æ ‡ï¼š
| éªŒè¯é¡¹ | é¢„æœŸç»“æœ | è¯´æ˜ |
| --- | --- | --- |
| æ•°æ®åˆ†å¸ƒ | 16å¼ è¡¨æ•°æ®é‡æ¥è¿‘ï¼ˆåå·®â‰¤10%ï¼‰ | æ‰§è¡Œ2.1æŸ¥çœ‹ |
| ç”¨æˆ·è®¢å•ä¸€è‡´æ€§ | è·¨è¡¨ç”¨æˆ·æ•°=0 | æ‰§è¡Œ2.2æŸ¥çœ‹ |
| æ•°æ®æ€»é‡ | æ‰©å®¹å‰åä¸€è‡´ | å¯¹æ¯”å‰åæ€»æ•° |


### å¿«é€ŸéªŒè¯è„šæœ¬ï¼š
```sql
-- ç»Ÿè®¡æ€»æ•°æ®é‡
SELECT 
    'æ‰©å®¹åæ€»æ•°æ®é‡' AS ç»Ÿè®¡é¡¹,
    SUM(cnt) AS æ€»æ•°
FROM (
    SELECT COUNT(*) AS cnt FROM damai_order_0.d_order_0
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_1
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_2
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_3
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_4
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_5
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_6
    UNION ALL SELECT COUNT(*) FROM damai_order_0.d_order_7
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_0
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_1
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_2
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_3
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_4
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_5
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_6
    UNION ALL SELECT COUNT(*) FROM damai_order_1.d_order_7
) t;
```

