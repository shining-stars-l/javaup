---
slug: /hmdp-plus/sharding/2
---

import PaidCTA from '@site/src/components/PaidCTA';

# 分库分表的具体实现-下

:::info plus 版本专属
此章节是黑马点评 Plus 版本中专有的内容，而在整套文档中将普通版本和 Plus 版本都融合在了一起，让大家更方便的学习。
:::

在上一章节，讲解了用户相关功能的分库分表的设计，本章节开始讲解其余部分

## 核心分片设计
### `tb_seckill_voucher`（秒杀券）
+ 选库：`voucher_id` 取模到 `ds_0` 或 `ds_1`。
+ 选表：`INLINE` 表达式按 `voucher_id.intdiv(2) % 2` 选择 `_0` 或 `_1`。
+ 直观理解：同一张券的所有请求落在同一库、且在该库内均衡到两张表，既保证原子性，又缓解单表热点。

### `tb_voucher`（券主数据）
    - 选库：`id` 取模。
    - 选表：`INLINE` 按 `id.intdiv(2) % 2` 切片。
    - 直观理解：主键是数值型，取模分库稳定，表内用“每两条一起走”的节奏分散写入。

### `tb_voucher_order`（券订单）
    - 选库：用 `user_id` 取模。
    - 选表：用 `voucher_id` 取模。
    - 直观理解：按用户聚合到一个库，库内按券不同扩散到两表，券维度与用户维度都能拿到最优路由。

### `tb_voucher_order_router`（订单路由映射）
    - 选库：`order_id` 哈希取模，字符串键分布更均匀。
    - 选表：`INLINE` 按 `order_id.intdiv(2) % 2`。
    - 直观理解：只要有订单号，就能在全局均匀地写入，并在库内稳定定位到具体表。

### `tb_voucher_reconcile_log`（对账日志）
    - 选库：`order_id` 哈希取模。
    - 选表：`INLINE` 按 `order_id.intdiv(2) % 2`。
    - 直观理解：日志量大但每条只和一个订单相关，按订单号稳定路由就对了。

## broadcastTables 的作用（重点）
### 配置位置：
```yaml
broadcastTables:
  - tb_blog,tb_blog_comments,tb_follow,tb_rollback_failure_log,tb_shop,tb_shop_type,tb_sign
```

### 含义：

<PaidCTA />