---
slug: /hmdp-plus/components/delay-queue-consume
---

import PaidCTA from '@site/src/components/PaidCTA';

# 如何实现高性能延迟队列-消费消息

:::info plus 版本专属
此章节是黑马点评 Plus 版本中专有的内容，而在整套文档中将普通版本和 Plus 版本都融合在了一起，让大家更方便的学习。
:::

在本文中，我们来介绍延迟队列组件消费消息的流程，关于组件的使用和发送消息的流程，可跳转到相应文档查看

[如何实现高性能延迟队列-发送消息](/hmdp-plus/components/delay-queue-produce)

建议小伙伴先学习完发送消息的流程后，再来学习本人内容。

## 消费消息
下面我们来开始分析，以订单延迟关闭为例，

```java
@Slf4j
@Component
public class DelayOrderCancelConsumer implements ConsumerTask {
    
    @Autowired
    private OrderService orderService;
    
    @Override
    public void execute(String content) {
        log.info("延迟订单取消消息进行消费 content : {}", content);
        if (StringUtil.isEmpty(content)) {
            log.error("延迟队列消息不存在");
            return;
        }
        DelayOrderCancelDto delayOrderCancelDto = JSON.parseObject(content, DelayOrderCancelDto.class);
        
        //取消订单
        OrderCancelDto orderCancelDto = new OrderCancelDto();
        orderCancelDto.setOrderNumber(delayOrderCancelDto.getOrderNumber());
        boolean cancel = orderService.cancel(orderCancelDto);
        if (cancel) {
            log.info("延迟订单取消成功 orderCancelDto : {}",content);
        }else {
            log.error("延迟订单取消失败 orderCancelDto : {}",content);
        }
    }
    
    @Override
    public String topic() {
        return SpringUtil.getPrefixDistinctionName() + "-" + DELAY_ORDER_CANCEL_TOPIC;
    }
}
```

**DelayOrderCancelConsumer** 是监听消息的处理类，实现了

```java
public interface ConsumerTask {
    
    /**
     * 消费任务
     * @param content 具体参数
     * */
    void execute(String content);
    /**
     * 主题
     * @return 主题
     * */
    String topic();
}
```

使用起来很简单，只要实现 **ConsumerTask** 接口的方法即可，然后注入到Spring中即可，

> **要注意同一个topic下的发送者和消费者配置的分区数要相同，默认为5**

```java
delay.queue.isolationRegionCount = 5
```

## 队列初始化
从服务启动来入手分析流程

<PaidCTA />
