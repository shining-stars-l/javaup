---
slug: /hmdp-plus/components/delay-queue-produce
---

import PaidCTA from '@site/src/components/PaidCTA';

# 如何实现高性能延迟队列-发送消息

:::info plus 版本专属
此章节是黑马点评 Plus 版本中专有的内容，而在整套文档中将普通版本和 Plus 版本都融合在了一起，让大家更方便的学习。
:::

使用 Redisson 实现延迟队列具有多个优点，这些优点源于 Redisson 对 Redis 功能的封装和扩展，以及 Redis 本身作为内存数据库的高性能特性。下面是使用 Redisson 延迟队列的主要好处：

#### 1. **简化开发**
+ **高级接口**：Redisson 提供了一系列高级的数据结构和同步工具，使得在 Java 应用中使用 Redis 更加简单直接。对于延迟队列，Redisson 提供的 `RDelayedQueue` 接口让开发者可以轻松实现延迟功能，无需深入了解复杂的底层实现细节

#### 2. **高性能和低延迟**
+ **内存操作**：由于 Redis 是基于内存的数据存储系统，它能够提供极高的读写速度，这对于实现高性能、低延迟的延迟队列非常重要。
+ **优化的通信**：Redisson 对 Redis 命令进行了优化，减少网络开销，进一步提高了操作的效率和速度


这里使用 Redisson 而不是用 RocketMQ 的原因有两点：

1. RocketMQ 虽然是本身支持延迟发送功能，但一旦消息发生堆积了。消息达不到指定的延时，而 Redisson 的方式比 MQ 的方式性能更叫高效。
2. 现在的项目中都会依赖 Redis，但并不都会依赖 RocketMQ，也是为了减少对中间件的依赖

## 使用 Redisson 的 RDelayedQueue 实现延迟队列
`RDelayedQueue` 是 Redisson 提供的一个接口，用于实现延迟队列的功能。它允许将元素延迟一段时间后再被消费。实现延迟队列的步骤如下：

1. **创建 RDelayedQueue**：首先需要创建一个普通的队列（例如 `RQueue` 或 `RBlockingQueue`），然后使用这个队列创建一个 `RDelayedQueue` 实例
2. **添加延迟元素**：通过 `RDelayedQueue` 的 `offer` 方法添加元素，并指定延迟时间。元素将在指定的延迟时间后自动转移到原始队列中，随后可被消费
3. **消费元素**：从原始队列中消费元素。如果是 `RBlockingQueue`，消费者可以阻塞等待直到元素可用

### 示例代码
下面是一个使用 Redisson 实现延迟队列的简单示例：

```java
// 创建 Redisson 客户端实例
Config config = new Config();
config.useSingleServer().setAddress("redis://127.0.0.1:6379");
RedissonClient redisson = Redisson.create(config);

// 获取一个 RBlockingQueue 实例
RBlockingQueue<String> queue = redisson.getBlockingQueue("myQueue");

// 使用 RBlockingQueue 创建 RDelayedQueue
RDelayedQueue<String> delayedQueue = redisson.getDelayedQueue(queue);

// 将一个元素添加到延迟队列中，延迟 10 秒钟
delayedQueue.offer("myElement", 10, TimeUnit.SECONDS);

// 在其他线程或者程序中，从 RBlockingQueue 中消费元素
String element = queue.take(); // 这会阻塞等待直到元素可用

// 关闭 Redisson 客户端
redisson.shutdown();
```

这个示例展示了如何创建一个延迟队列，向其中添加一个延迟 10 秒的元素，并从原始队列中阻塞消费这个元素

### 注意事项
+ 使用 `RDelayedQueue` 时，延迟的元素实际上是首先存储在 Redis 中的一个内部列表中，然后在到期后转移到目标队列。因此，需要保持 Redisson 实例运行，以便它可以处理延迟元素的转移
+ 当 Redisson 客户端重启时，`RDelayedQueue` 的状态会被自动恢复，因为其状态是持久化在 Redis 中的。这意味着即使应用重启，延迟队列的功能也不会受到影响

而本人在 Redisson 延迟队列基础上进一步进行了优化，使用了对消息进行分片的策略，并结合了线程池并发的执行消费。使得 **执行效率成几倍的提升**，也是强烈建议小伙伴学会此组件的设计，在面试上绝对是装逼利器！

<PaidCTA />