---
slug: /hmdp-plus/restock-notify/subscription-flow
---

import PaidCTA from '@site/src/components/PaidCTA';

# 无库存订阅与到券通知全流程

:::info plus 版本专属
此章节是黑马点评 Plus 版本中专有的内容，而在整套文档中将普通版本和 Plus 版本都融合在了一起，让大家更方便的学习。
:::

当店铺中的优惠券库存为 0，并且此用户还没有优惠券时，会提醒用户添加“到券提醒”的功能：

<img src="/img/hmdp-plus/到券提醒系统设计与最佳实践/1.png" alt="表关系" width="40%" />

让有其他的人将已领取的优惠券取消或者商家新增库存后，就会把设置了到券提醒的用户来领取优惠券。

并且领取的用户是有**公平性**的，也就是**先来的用户会先领取到**。

本章节将会详细的讲解此功能的实现流程

## 一、“到券提醒”功能解析
### 流程图

```mermaid
sequenceDiagram
    autonumber
    participant U as 用户
    participant VS as 实现
    participant RC as Redis缓存
    participant SVS as 数据库

    U->>VS: 订阅
    VS->>RC: TTL = EXPIRE(SECKILL_VOUCHER_TAG_KEY:{voucherId})
    alt TTL 不存在或<=0
        VS->>SVS: DB查询秒杀券 by voucherId
        VS->>VS: ttlSeconds = max(now→endTime,1) 或 3600
    end

    VS->>RC: purchased = SISMEMBER(SECKILL_USER_TAG_KEY:{voucherId}, userId)
    alt 已购
        VS->>RC: HSET(SECKILL_SUBSCRIBE_STATUS_TAG_KEY:{voucherId}, userId=SUCCESS, ttl)
        VS->>RC: EXPIRE(statusKey, ttl)
        VS-->>U: 完成（已购）
    else 未购
        VS->>RC: added = SADD(SECKILL_SUBSCRIBE_USER_TAG_KEY:{voucherId}, userId)
        VS->>RC: EXPIRE(setKey, ttl)
        alt 首次加入(added>0)
            VS->>RC: ZADD(SECKILL_SUBSCRIBE_ZSET_TAG_KEY:{voucherId}, score=nowMillis, member=userId, ttl)
        else 已在队列
            VS->>RC: EXPIRE(zsetKey, ttl)
        end
        VS->>RC: prev = HGET(SECKILL_SUBSCRIBE_STATUS_TAG_KEY:{voucherId}, userId)
        alt prev != SUCCESS
            VS->>RC: HSET(SECKILL_SUBSCRIBE_STATUS_TAG_KEY:{voucherId}, userId=SUBSCRIBED, ttl)
        end
        VS->>RC: EXPIRE(statusKey, ttl)
        VS-->>U: 完成（订阅成功）
    end

    Note over VS,RC: 库存增加时，异步从订阅ZSET取最早未购用户自动分配资格
```

### 代码实现

<PaidCTA />