---
slug: /hmdp-plus/restock-notify/fair-allocation
---

import PaidCTA from '@site/src/components/PaidCTA';

# 如何公平性的自动分配已订阅用户

:::info plus 版本专属
此章节是黑马点评 Plus 版本中专有的内容，而在整套文档中将普通版本和 Plus 版本都融合在了一起，让大家更方便的学习。
:::

在上一章节讲解了用户选择“到券通知”，以及取消“到券通知”的功能全流程，那么这节就来分析当有库存增加或者其他人取消已领取的优惠券后，是如何能够公平性的选择已经订阅的用户，按照先来先订阅的原则来通知用户。

## 一、通知已订阅用户的流程
### 1.1 方法目的
+ 在库存回滚后，尝试把该资格自动发给订阅了该券、且尚未购买的用户中“最早订阅”的那位，避免浪费回滚出来的库存。
+ 会对券的有效期与数据完整性进行校验，并确保候选用户不是刚刚取消的用户、也不在已购集合里。
+ 成功找到候选后，交由后续的扣减与消息流程去执行。

### 先看自动发券部分
回滚后自动发券：挑选订阅ZSET中按加入时间最早的未购用户，执行Lua扣减并下发Kafka消息。
 - 不修改订阅集合与状态，成功下单后用户将出现在已购集合，状态查询会返回SUCCESS；
 - 为避免重复，筛选时排除已购用户与当前取消用户；
 - 采用范围批量读取前N条并按score最小选取候选，避免由于Set去序导致的顺序丢失。

<PaidCTA />