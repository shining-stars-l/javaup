---
slug: /framework/rabbitmq/advanced-features
---
# é«˜çº§ç‰¹æ€§ä¸åº”ç”¨åœºæ™¯

## æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)æœºåˆ¶

æ­»ä¿¡é˜Ÿåˆ—æ˜¯RabbitMQæä¾›çš„ä¸€ç§æ¶ˆæ¯å…œåº•æœºåˆ¶,ç”¨äºå¤„ç†æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„"é—®é¢˜æ¶ˆæ¯"ã€‚å½“æ¶ˆæ¯å› ç‰¹å®šåŸå› æ— æ³•æŠ•é€’ç»™æ¶ˆè´¹è€…æ—¶,è¿™äº›æ¶ˆæ¯ä¼šè¢«è½¬å‘åˆ°æ­»ä¿¡äº¤æ¢æœº,æœ€ç»ˆè·¯ç”±åˆ°æ­»ä¿¡é˜Ÿåˆ—ç­‰å¾…ç‰¹æ®Šå¤„ç†ã€‚

### æ¶ˆæ¯æˆä¸ºæ­»ä¿¡çš„å››ç§åœºæ™¯

```mermaid
graph TB
    NormalQ[æ­£å¸¸é˜Ÿåˆ—] --> Check{æ¶ˆæ¯æ£€æŸ¥}
    
    Check -->|æ¶ˆè´¹è€…æ‹’ç»<br/>basicReject/basicNack<br/>requeue=false| DL1[æ­»ä¿¡]
    Check -->|æ¶ˆæ¯è¿‡æœŸ<br/>TTLè¶…æ—¶| DL2[æ­»ä¿¡]
    Check -->|é˜Ÿåˆ—æ»¡<br/>è¾¾åˆ°max-lengthä¸Šé™| DL3[æ­»ä¿¡]
    Check -->|æ— æ³•è·¯ç”±<br/>æ²¡æœ‰åŒ¹é…çš„æ¶ˆè´¹è€…| DL4[æ­»ä¿¡]
    
    DL1 --> DLX[æ­»ä¿¡äº¤æ¢æœº<br/>Dead Letter Exchange]
    DL2 --> DLX
    DL3 --> DLX
    DL4 --> DLX
    
    DLX -->|è·¯ç”±| DLQ[æ­»ä¿¡é˜Ÿåˆ—<br/>Dead Letter Queue]
    
    DLQ --> Handler[ç‰¹æ®Šå¤„ç†<br/>äººå·¥å®¡æ ¸/æ—¥å¿—è®°å½•/å‘Šè­¦]
    
    style NormalQ fill:#4CAF50,stroke:#388E3C,stroke-width:2px,rx:10,ry:10
    style DLX fill:#F44336,stroke:#D32F2F,stroke-width:2px,rx:10,ry:10
    style DLQ fill:#FF9800,stroke:#F57C00,stroke-width:2px,rx:10,ry:10
```

#### 1. æ¶ˆè´¹è€…æ‹’ç»ä¸”ä¸é‡æ–°å…¥é˜Ÿ

æ¶ˆè´¹è€…è°ƒç”¨`basicReject()`æˆ–`basicNack()`æ—¶,å°†`requeue`å‚æ•°è®¾ç½®ä¸º`false`:

```java
// æ¶ˆæ¯æ ¼å¼é”™è¯¯,ä¸šåŠ¡æ— æ³•å¤„ç†
channel.basicReject(deliveryTag, false);  // æ‹’ç»æ¶ˆæ¯,ä¸é‡æ–°å…¥é˜Ÿ
```

#### 2. æ¶ˆæ¯TTLè¿‡æœŸ

é˜Ÿåˆ—æˆ–æ¶ˆæ¯è®¾ç½®äº†è¿‡æœŸæ—¶é—´(Time-To-Live),è¶…æ—¶æœªè¢«æ¶ˆè´¹:

```java
// è®¾ç½®æ¶ˆæ¯10ç§’åè¿‡æœŸ
Map<String, Object> args = new HashMap<>();
args.put("x-message-ttl", 10000);
channel.queueDeclare("timeout_queue", true, false, false, args);
```

#### 3. é˜Ÿåˆ—é•¿åº¦è¶…é™

é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦é™åˆ¶(`x-max-length`),æ–°æ¶ˆæ¯ä¼šå°†æœ€æ—©çš„æ¶ˆæ¯æŒ¤å‡ºå˜æˆæ­»ä¿¡:

```java
Map<String, Object> args = new HashMap<>();
args.put("x-max-length", 1000);  // é˜Ÿåˆ—æœ€å¤šå­˜å‚¨1000æ¡æ¶ˆæ¯
```

#### 4. æ¶ˆæ¯æ— æ³•è·¯ç”±

Exchangeæ‰¾ä¸åˆ°åŒ¹é…çš„é˜Ÿåˆ—æ—¶,å¦‚æœé…ç½®äº†æ­»ä¿¡æœºåˆ¶,æ¶ˆæ¯ä¼šè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ã€‚

### æ­»ä¿¡é˜Ÿåˆ—é…ç½®å®æˆ˜

ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºå¦‚ä½•é…ç½®å®Œæ•´çš„æ­»ä¿¡é˜Ÿåˆ—ä½“ç³»:

```java
import org.springframework.amqp.core.*;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import java.util.HashMap;
import java.util.Map;

@Configuration
public class DeadLetterQueueConfig {
    
    // ============ æ­»ä¿¡äº¤æ¢æœºå’Œé˜Ÿåˆ— ============
    
    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("dlx_exchange");
    }
    
    @Bean
    public Queue deadLetterQueue() {
        return new Queue("dlx_queue", true);
    }
    
    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder.bind(deadLetterQueue())
                            .to(deadLetterExchange())
                            .with("dlx_routing_key");
    }
    
    // ============ ä¸šåŠ¡äº¤æ¢æœºå’Œé˜Ÿåˆ— ============
    
    @Bean
    public DirectExchange businessExchange() {
        return new DirectExchange("business_exchange");
    }
    
    @Bean
    public Queue businessQueue() {
        Map<String, Object> args = new HashMap<>();
        // ç»‘å®šæ­»ä¿¡äº¤æ¢æœº
        args.put("x-dead-letter-exchange", "dlx_exchange");
        // æ­»ä¿¡è·¯ç”±é”®
        args.put("x-dead-letter-routing-key", "dlx_routing_key");
        // å¯é€‰:è®¾ç½®æ¶ˆæ¯TTLä¸º30ç§’
        args.put("x-message-ttl", 30000);
        // å¯é€‰:é˜Ÿåˆ—æœ€å¤§é•¿åº¦
        args.put("x-max-length", 10000);
        
        return QueueBuilder.durable("business_queue")
                          .withArguments(args)
                          .build();
    }
    
    @Bean
    public Binding businessBinding() {
        return BindingBuilder.bind(businessQueue())
                            .to(businessExchange())
                            .with("business_routing_key");
    }
}
```

### æ¶ˆè´¹è€…ç›‘å¬å®ç°

```java
import com.rabbitmq.client.Channel;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
import java.io.IOException;

@Component
public class DeadLetterConsumer {
    
    /**
     * ä¸šåŠ¡é˜Ÿåˆ—æ¶ˆè´¹è€…
     */
    @RabbitListener(queues = "business_queue")
    public void processBusinessMessage(Message message, Channel channel) 
            throws IOException {
        String content = new String(message.getBody());
        long deliveryTag = message.getMessageProperties().getDeliveryTag();
        
        try {
            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†
            if (content.contains("error")) {
                // æ¶ˆæ¯æ ¼å¼å¼‚å¸¸,æ‹’ç»å¹¶è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—
                channel.basicReject(deliveryTag, false);
                System.err.println("æ¶ˆæ¯å¼‚å¸¸,å·²è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—: " + content);
            } else {
                // æ­£å¸¸å¤„ç†
                System.out.println("å¤„ç†ä¸šåŠ¡æ¶ˆæ¯: " + content);
                channel.basicAck(deliveryTag, false);
            }
        } catch (Exception e) {
            // å¼‚å¸¸æƒ…å†µæ‹’ç»æ¶ˆæ¯
            channel.basicNack(deliveryTag, false, false);
        }
    }
    
    /**
     * æ­»ä¿¡é˜Ÿåˆ—æ¶ˆè´¹è€… - å¤„ç†å¼‚å¸¸æ¶ˆæ¯
     */
    @RabbitListener(queues = "dlx_queue")
    public void processDeadLetter(Message message, Channel channel) 
            throws IOException {
        String content = new String(message.getBody());
        long deliveryTag = message.getMessageProperties().getDeliveryTag();
        
        // è®°å½•æ­»ä¿¡æ—¥å¿—,å‘é€å‘Šè­¦,æˆ–äººå·¥å®¡æ ¸
        System.err.println("ğŸš¨ æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯,éœ€è¦äººå·¥å¤„ç†: " + content);
        logDeadLetterToDatabase(content);
        sendAlertNotification(content);
        
        // ç¡®è®¤æ­»ä¿¡æ¶ˆæ¯å·²å¤„ç†
        channel.basicAck(deliveryTag, false);
    }
    
    private void logDeadLetterToDatabase(String content) {
        // æŒä¹…åŒ–æ­»ä¿¡è®°å½•åˆ°æ•°æ®åº“
    }
    
    private void sendAlertNotification(String content) {
        // å‘é€å‘Šè­¦é€šçŸ¥
    }
}
```

### æ­»ä¿¡é˜Ÿåˆ—çš„å…¸å‹åº”ç”¨

#### åº”ç”¨1: å®ç°å»¶è¿Ÿæ¶ˆæ¯

åˆ©ç”¨TTLè¿‡æœŸæœºåˆ¶,å°†æ¶ˆæ¯å‘é€åˆ°ä¸æ¶ˆè´¹çš„é˜Ÿåˆ—,ç­‰å¾…è¿‡æœŸåè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œå®é™…å¤„ç†:

```mermaid
sequenceDiagram
    participant P as ç”Ÿäº§è€…
    participant DelayQ as å»¶è¿Ÿé˜Ÿåˆ—<br/>(è®¾ç½®TTL,æ— æ¶ˆè´¹è€…)
    participant DLX as æ­»ä¿¡äº¤æ¢æœº
    participant RealQ as å®é™…ä¸šåŠ¡é˜Ÿåˆ—
    participant C as æ¶ˆè´¹è€…
    
    P->>DelayQ: å‘é€æ¶ˆæ¯<br/>TTL=30åˆ†é’Ÿ
    Note over DelayQ: æ¶ˆæ¯æš‚å­˜,æ— äººæ¶ˆè´¹
    Note over DelayQ: ç­‰å¾…30åˆ†é’Ÿ...
    DelayQ->>DLX: TTLè¿‡æœŸ,è½¬ä¸ºæ­»ä¿¡
    DLX->>RealQ: è·¯ç”±åˆ°ä¸šåŠ¡é˜Ÿåˆ—
    RealQ->>C: æ¨é€æ¶ˆæ¯
    C->>C: æ‰§è¡Œå…³å•é€»è¾‘
```

**å…¸å‹åœºæ™¯**: è®¢å•è¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨å…³é—­ã€ä¼˜æƒ åˆ¸åˆ°æœŸæé†’ç­‰ã€‚

**ä¼˜åŠ¿**: 
- å»¶è¿Ÿæ—¶é—´çµæ´»,æ”¯æŒä»»æ„æ—¶é•¿(RocketMQä»…æ”¯æŒå›ºå®šçº§åˆ«)
- åŸºäºRabbitMQé›†ç¾¤,å¤©ç„¶é«˜å¯ç”¨

**ç¼ºé™·**: 
- é˜Ÿå¤´é˜»å¡é—®é¢˜: RabbitMQä»…æ£€æŸ¥é˜Ÿé¦–æ¶ˆæ¯æ˜¯å¦è¿‡æœŸ,å¦‚æœé˜Ÿé¦–æ¶ˆæ¯TTLè¾ƒé•¿,ä¼šé˜»å¡åç»­å·²è¿‡æœŸçš„æ¶ˆæ¯
- æ–¹æ¡ˆå¤æ‚åº¦é«˜,éœ€è¦ç»´æŠ¤å¤šå¥—é˜Ÿåˆ—å’Œäº¤æ¢æœº

#### åº”ç”¨2: æ¶ˆæ¯å¤„ç†å¤±è´¥å…œåº•

ä¸šåŠ¡æ¶ˆæ¯å¤„ç†å¤±è´¥å,è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œè¡¥å¿å¤„ç†æˆ–äººå·¥ä»‹å…¥:

```java
// æ”¯ä»˜å›è°ƒå¤„ç†å¤±è´¥,è½¬å…¥æ­»ä¿¡é˜Ÿåˆ—ç­‰å¾…äººå·¥å®¡æ ¸
if (!updateOrderStatus(orderId)) {
    channel.basicReject(deliveryTag, false);  // è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
}
```

## å»¶è¿Ÿæ¶ˆæ¯çš„ä¸¤ç§å®ç°æ–¹å¼

### æ–¹æ¡ˆä¸€: åŸºäºæ­»ä¿¡é˜Ÿåˆ—(TTL)

å¦‚ä¸Šæ–‡æ‰€è¿°,é€šè¿‡TTLè¿‡æœŸæœºåˆ¶å®ç°å»¶è¿Ÿæ¶ˆæ¯ã€‚

**é™åˆ¶**:
- é˜Ÿå¤´é˜»å¡: éœ€è¦ä¿è¯æ¶ˆæ¯æŒ‰è¿‡æœŸæ—¶é—´æœ‰åº,å¦åˆ™é•¿å»¶æ—¶æ¶ˆæ¯ä¼šé˜»å¡çŸ­å»¶æ—¶æ¶ˆæ¯
- èµ„æºæ¶ˆè€—: æ¯ä¸ªå»¶è¿Ÿçº§åˆ«å¯èƒ½éœ€è¦ç‹¬ç«‹çš„é˜Ÿåˆ—

### æ–¹æ¡ˆäºŒ: åŸºäºå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶

RabbitMQå®˜æ–¹æä¾›çš„`rabbitmq_delayed_message_exchange`æ’ä»¶,ä»3.6.12ç‰ˆæœ¬å¼€å§‹æ”¯æŒ,è§£å†³äº†æ­»ä¿¡é˜Ÿåˆ—çš„é˜Ÿå¤´é˜»å¡é—®é¢˜ã€‚

#### æ’ä»¶å·¥ä½œåŸç†

```mermaid
graph TB
    P[ç”Ÿäº§è€…] -->|å‘é€å»¶è¿Ÿæ¶ˆæ¯<br/>x-delay=30000| DX[Delayed Exchange<br/>ç±»å‹:x-delayed-message]
    
    DX -->|æš‚å­˜æ¶ˆæ¯| MNESIA[(Mnesiaæ•°æ®åº“<br/>Erlangå†…ç½®)]
    
    MNESIA -->|å®šæ—¶å™¨æ‰«æ| TIMER[å®šæ—¶è°ƒåº¦å™¨]
    TIMER -->|åˆ°æœŸæ£€æµ‹| CHECK{æ˜¯å¦åˆ°æœŸ?}
    
    CHECK -->|æœªåˆ°æœŸ| WAIT[ç»§ç»­ç­‰å¾…]
    CHECK -->|å·²åˆ°æœŸ| DELIVER[æŠ•é€’åˆ°é˜Ÿåˆ—]
    
    DELIVER --> Q[ç›®æ ‡é˜Ÿåˆ—]
    Q --> C[æ¶ˆè´¹è€…]
    
    style DX fill:#4CAF50,stroke:#388E3C,stroke-width:2px,rx:10,ry:10
    style MNESIA fill:#2196F3,stroke:#1976D2,stroke-width:2px,rx:10,ry:10
    style TIMER fill:#FF9800,stroke:#F57C00,stroke-width:2px,rx:10,ry:10
```

**æ ¸å¿ƒå·®å¼‚**: 
- æ­»ä¿¡æ–¹æ¡ˆ: æ¶ˆæ¯å…ˆè¿›é˜Ÿåˆ—,è¿‡æœŸåè½¬å‘
- æ’ä»¶æ–¹æ¡ˆ: æ¶ˆæ¯å…ˆå­˜Mnesiaæ•°æ®åº“,å®šæ—¶å™¨åˆ°æœŸåæ‰æŠ•é€’åˆ°é˜Ÿåˆ—

#### æ’ä»¶é…ç½®ç¤ºä¾‹

```java
@Configuration
public class DelayedMessageConfig {
    
    @Bean
    public CustomExchange delayedExchange() {
        Map<String, Object> args = new HashMap<>();
        args.put("x-delayed-type", "direct");  // æŒ‡å®šåº•å±‚äº¤æ¢æœºç±»å‹
        
        // å£°æ˜å»¶è¿Ÿäº¤æ¢æœº,ç±»å‹ä¸ºx-delayed-message
        return new CustomExchange("delayed_exchange", 
                                 "x-delayed-message", 
                                 true, 
                                 false, 
                                 args);
    }
    
    @Bean
    public Queue delayedQueue() {
        return new Queue("delayed_queue", true);
    }
    
    @Bean
    public Binding delayedBinding() {
        return BindingBuilder.bind(delayedQueue())
                            .to(delayedExchange())
                            .with("delayed_routing_key")
                            .noargs();
    }
}
```

#### å‘é€å»¶è¿Ÿæ¶ˆæ¯

```java
@Service
public class DelayedMessageProducer {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendDelayedMessage(String content, int delayMillis) {
        rabbitTemplate.convertAndSend(
            "delayed_exchange", 
            "delayed_routing_key", 
            content,
            message -> {
                // è®¾ç½®å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)
                message.getMessageProperties()
                       .setHeader("x-delay", delayMillis);
                return message;
            }
        );
        
        System.out.println("å‘é€å»¶è¿Ÿæ¶ˆæ¯,å»¶è¿Ÿæ—¶é—´: " + delayMillis + "ms");
    }
}

// ä½¿ç”¨ç¤ºä¾‹:30åˆ†é’Ÿåå…³é—­è®¢å•
delayedMessageProducer.sendDelayedMessage(
    "{\"orderId\":123456}", 
    30 * 60 * 1000  // 30åˆ†é’Ÿ
);
```

#### æ’ä»¶æ–¹æ¡ˆçš„é™åˆ¶

1. **å»¶è¿Ÿæ—¶é—´ä¸Šé™**: æœ€å¤§æ”¯æŒ`(2^32)-1`æ¯«ç§’,çº¦49å¤©,è¶…è¿‡ä¼šè¢«ç«‹å³æŠ•é€’
2. **æ•°æ®å¯é æ€§**: æ¶ˆæ¯å­˜å‚¨åœ¨Mnesiaæ•°æ®åº“,ä»…åœ¨å½“å‰èŠ‚ç‚¹æœ‰å•ä¸ªç£ç›˜å‰¯æœ¬,å­˜åœ¨ä¸¢å¤±é£é™©
3. **æ€§èƒ½ç“¶é¢ˆ**: ä¸é€‚åˆå¤§é‡å»¶è¿Ÿæ¶ˆæ¯åœºæ™¯(æ•°åä¸‡æˆ–ç™¾ä¸‡çº§),è¯¦è§å®˜æ–¹issue [#72](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/issues/72)
4. **å®šæ—¶å™¨æ¼‚ç§»**: ä¾èµ–Erlangå®šæ—¶å™¨,å¤§é‡é•¿æ—¶é—´å®šæ—¶å™¨ä¼šäº‰ç”¨è°ƒåº¦å™¨èµ„æº,å¯¼è‡´æ—¶é—´ç²¾åº¦ä¸‹é™

**å®˜æ–¹æ–‡æ¡£**: [rabbitmq-delayed-message-exchange](https://github.com/rabbitmq/rabbitmq-delayed-message-exchange#limitations)

### å»¶è¿Ÿæ¶ˆæ¯æ–¹æ¡ˆå¯¹æ¯”

| å¯¹æ¯”ç»´åº¦ | æ­»ä¿¡é˜Ÿåˆ—æ–¹æ¡ˆ | å»¶è¿Ÿæ’ä»¶æ–¹æ¡ˆ |
|---------|------------|------------|
| å»¶è¿Ÿæ—¶é—´é™åˆ¶ | æ— é™åˆ¶ | æœ€å¤§49å¤© |
| é˜Ÿå¤´é˜»å¡ | å­˜åœ¨ | ä¸å­˜åœ¨ |
| æ¶ˆæ¯å­˜å‚¨ | é˜Ÿåˆ—æŒä¹…åŒ– | Mnesiaæ•°æ®åº“ |
| å¯é æ€§ | é«˜(æ”¯æŒé›†ç¾¤å¤åˆ¶) | ä¸­(å•èŠ‚ç‚¹å‰¯æœ¬) |
| æ€§èƒ½ | ä¸­ç­‰ | å¤§é‡æ¶ˆæ¯æ—¶æ€§èƒ½å·® |
| é…ç½®å¤æ‚åº¦ | é«˜(éœ€è¦å¤šå¥—é˜Ÿåˆ—) | ä½(ä»…éœ€å®‰è£…æ’ä»¶) |
| ç‰ˆæœ¬è¦æ±‚ | æ—  | â‰¥3.6.12 |

**é€‰å‹å»ºè®®**:
- å»¶è¿Ÿæ—¶é—´å›ºå®šä¸”æ•°é‡ä¸å¤§: ä½¿ç”¨å»¶è¿Ÿæ’ä»¶,é…ç½®ç®€å•
- æµ·é‡å»¶è¿Ÿæ¶ˆæ¯æˆ–é«˜å¯é æ€§è¦æ±‚: ä½¿ç”¨æ­»ä¿¡é˜Ÿåˆ—,æˆ–è€ƒè™‘ä¸“ä¸šçš„å»¶è¿Ÿæ¶ˆæ¯ä¸­é—´ä»¶(å¦‚RocketMQã€æ—¶åºæ•°æ®åº“)

## äº‹åŠ¡æœºåˆ¶(Transaction)

RabbitMQçš„äº‹åŠ¡æœºåˆ¶æä¾›äº†å¦ä¸€ç§ä¿è¯æ¶ˆæ¯å¯é æŠ•é€’çš„æ–¹å¼,å…è®¸å°†ä¸€ç»„æ“ä½œæ‰“åŒ…æˆåŸå­å•å…ƒ,è¦ä¹ˆå…¨éƒ¨æˆåŠŸ,è¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚

### äº‹åŠ¡ç›¸å…³æ–¹æ³•

AMQPåè®®å®šä¹‰äº†ä¸‰ä¸ªäº‹åŠ¡æ§åˆ¶æ–¹æ³•:

```mermaid
graph LR
    START[å¼€å§‹] -->|txSelect| TX_MODE[å¼€å¯äº‹åŠ¡æ¨¡å¼]
    TX_MODE --> SEND[å‘é€æ¶ˆæ¯]
    SEND --> CHECK{æ˜¯å¦å‡ºç°å¼‚å¸¸?}
    
    CHECK -->|æ— å¼‚å¸¸| COMMIT[txCommitæäº¤]
    CHECK -->|æœ‰å¼‚å¸¸| ROLLBACK[txRollbackå›æ»š]
    
    COMMIT --> SUCCESS[æ¶ˆæ¯æˆåŠŸæŠ•é€’]
    ROLLBACK --> FAIL[æ¶ˆæ¯æœªæŠ•é€’,å›æ»š]
    
    style TX_MODE fill:#4CAF50,stroke:#388E3C,stroke-width:2px,rx:10,ry:10
    style COMMIT fill:#2196F3,stroke:#1976D2,stroke-width:2px,rx:10,ry:10
    style ROLLBACK fill:#F44336,stroke:#D32F2F,stroke-width:2px,rx:10,ry:10
```

- **txSelect()**: å°†å½“å‰Channelè®¾ç½®ä¸ºäº‹åŠ¡æ¨¡å¼
- **txCommit()**: æäº¤äº‹åŠ¡,æ¶ˆæ¯æ­£å¼æŠ•é€’
- **txRollback()**: å›æ»šäº‹åŠ¡,æ’¤é”€æ‰€æœ‰æ“ä½œ

### äº‹åŠ¡å®ç°ç¤ºä¾‹

```java
import com.rabbitmq.client.*;

public class TransactionExample {
    
    public static void main(String[] args) throws Exception {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost("localhost");
        
        try (Connection connection = factory.newConnection();
             Channel channel = connection.createChannel()) {
            
            // 1. å¼€å¯äº‹åŠ¡æ¨¡å¼
            channel.txSelect();
            
            String exchangeName = "transaction_exchange";
            String routingKey = "transaction_key";
            
            try {
                // 2. å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
                String message1 = "{\"type\":\"withdraw\",\"amount\":500}";
                channel.basicPublish(exchangeName, routingKey, 
                                   null, message1.getBytes());
                System.out.println("å‘é€æ¶ˆæ¯1: æ‰£æ¬¾500å…ƒ");
                
                // 3. å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯
                String message2 = "{\"type\":\"notify\",\"content\":\"æ‰£æ¬¾æˆåŠŸ\"}";
                channel.basicPublish(exchangeName, routingKey, 
                                   null, message2.getBytes());
                System.out.println("å‘é€æ¶ˆæ¯2: å‘é€é€šçŸ¥");
                
                // 4. æ¨¡æ‹Ÿä¸šåŠ¡å¼‚å¸¸
                if (Math.random() > 0.5) {
                    throw new RuntimeException("ä¸šåŠ¡æ ¡éªŒå¤±è´¥");
                }
                
                // 5. æäº¤äº‹åŠ¡
                channel.txCommit();
                System.out.println("âœ“ äº‹åŠ¡æäº¤æˆåŠŸ,ä¸¤æ¡æ¶ˆæ¯å…¨éƒ¨æŠ•é€’");
                
            } catch (Exception e) {
                // 6. å›æ»šäº‹åŠ¡
                channel.txRollback();
                System.err.println("âœ— äº‹åŠ¡å›æ»š,æ¶ˆæ¯å…¨éƒ¨æ’¤é”€: " + e.getMessage());
            }
        }
    }
}
```

### äº‹åŠ¡æœºåˆ¶çš„ç‰¹ç‚¹

**ä¼˜ç‚¹**:
- ä¿è¯ä¸€ç»„æ¶ˆæ¯çš„åŸå­æ€§,è¦ä¹ˆå…¨éƒ¨æˆåŠŸè¦ä¹ˆå…¨éƒ¨å¤±è´¥
- å®ç°ç®€å•,ä¸éœ€è¦é¢å¤–çš„å›è°ƒå¤„ç†

**ç¼ºç‚¹**:
- **æ€§èƒ½æå·®**: äº‹åŠ¡æ˜¯åŒæ­¥é˜»å¡çš„,æ¯æ¬¡commitéœ€è¦ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤,ååé‡ä»…ä¸ºConfirmæœºåˆ¶çš„1/10
- **ä¸æ”¯æŒæ‰¹é‡**: äº‹åŠ¡æäº¤æ˜¯ä¸²è¡Œçš„,æ— æ³•åˆ©ç”¨æ‰¹é‡æ“ä½œæå‡æ€§èƒ½

### äº‹åŠ¡ vs Confirmæœºåˆ¶å¯¹æ¯”

| å¯¹æ¯”ç»´åº¦ | äº‹åŠ¡æœºåˆ¶ | Confirmæœºåˆ¶ |
|---------|---------|-----------|
| æ‰§è¡Œæ–¹å¼ | åŒæ­¥é˜»å¡ | å¼‚æ­¥å›è°ƒ |
| æ€§èƒ½ | æä½(çº¦1000 msg/s) | é«˜(çº¦10000 msg/s) |
| å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰(éœ€è¦å¤„ç†å›è°ƒ) |
| é€‚ç”¨åœºæ™¯ | å°æµé‡ã€å¼ºä¸€è‡´æ€§è¦æ±‚ | é«˜å¹¶å‘ã€é«˜åååœºæ™¯ |

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**: 
- ä¼˜å…ˆä½¿ç”¨Confirmæœºåˆ¶,æ€§èƒ½å’Œå¯é æ€§å…¼å…·
- ä»…åœ¨å¯¹æ€§èƒ½æ— è¦æ±‚ä¸”éœ€è¦ä¸¥æ ¼äº‹åŠ¡ä¿è¯çš„åœºæ™¯ä¸‹è€ƒè™‘äº‹åŠ¡æœºåˆ¶
- å¯¹äºå¤æ‚çš„åˆ†å¸ƒå¼äº‹åŠ¡,å»ºè®®ä½¿ç”¨æœ¬åœ°æ¶ˆæ¯è¡¨ã€TCCã€Sagaç­‰åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

## æŠ€æœ¯é€‰å‹æ€»ç»“

| éœ€æ±‚åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|---------|---------|-----|
| å»¶è¿Ÿæ¶ˆæ¯(å°è§„æ¨¡) | å»¶è¿Ÿæ’ä»¶ | é…ç½®ç®€å•,æ— é˜Ÿå¤´é˜»å¡ |
| å»¶è¿Ÿæ¶ˆæ¯(å¤§è§„æ¨¡) | æ­»ä¿¡é˜Ÿåˆ—æˆ–ä¸“ä¸šä¸­é—´ä»¶ | æ€§èƒ½å’Œå¯é æ€§æ›´å¥½ |
| å¼‚å¸¸æ¶ˆæ¯å¤„ç† | æ­»ä¿¡é˜Ÿåˆ— | æä¾›æ¶ˆæ¯å…œåº•å’Œå®¡è®¡èƒ½åŠ› |
| å¯é æ¶ˆæ¯æŠ•é€’ | Confirmæœºåˆ¶ | é«˜æ€§èƒ½å¼‚æ­¥ç¡®è®¤ |
| å¼ºäº‹åŠ¡ä¿è¯(ä½å¹¶å‘) | äº‹åŠ¡æœºåˆ¶ | ç®€å•ç›´æ¥,é€‚åˆå°æµé‡ |
| åˆ†å¸ƒå¼äº‹åŠ¡ | æœ¬åœ°æ¶ˆæ¯è¡¨/TCC/Saga | åº”ç”¨å±‚æ–¹æ¡ˆæ›´å¯æ§ |
