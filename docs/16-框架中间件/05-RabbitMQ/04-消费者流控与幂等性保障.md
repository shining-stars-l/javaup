---
slug: /framework/rabbitmq/04-æ¶ˆè´¹è€…æµæ§ä¸å¹‚ç­‰æ€§ä¿éšœ
---
## æ¶ˆè´¹ç«¯é™æµæœºåˆ¶

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹,æ¶ˆæ¯çš„çªå‘æ€§å¢é•¿å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…è¿‡è½½ç”šè‡³å´©æºƒã€‚æ¶ˆè´¹ç«¯é™æµ(Flow Control)æ˜¯ä¸€ç§ä¿æŠ¤æ€§æªæ–½,é€šè¿‡æ§åˆ¶æ¶ˆæ¯æ¨é€é€Ÿç‡,é¿å…æ¶ˆè´¹è€…è¢«å¤§é‡æ¶ˆæ¯å‹å®ã€‚

### é™æµçš„å¿…è¦æ€§

**å…¸å‹é—®é¢˜åœºæ™¯**:
- ä¸šåŠ¡é«˜å³°æœŸæ¶ˆæ¯å¤§é‡ç§¯å‹,æ¶ˆè´¹è€…å¤„ç†ä¸è¿‡æ¥
- æ¶ˆè´¹è€…æœåŠ¡é¢‘ç¹OOMæˆ–CPUæ‰“æ»¡,ä¸æ–­é‡å¯
- é‡å¯åç¬é—´æ¶Œå…¥å¤§é‡æ¶ˆæ¯,å†æ¬¡è¢«æ‰“æŒ‚,å½¢æˆæ¶æ€§å¾ªç¯

```mermaid
graph TB
    Q[é˜Ÿåˆ—å †ç§¯100ä¸‡æ¶ˆæ¯] -->|ç¬é—´æ¨é€| C1[æ¶ˆè´¹è€…å®ä¾‹1]
    Q -->|ç¬é—´æ¨é€| C2[æ¶ˆè´¹è€…å®ä¾‹2]
    Q -->|ç¬é—´æ¨é€| C3[æ¶ˆè´¹è€…å®ä¾‹3]
    
    C1 -->|å†…å­˜æº¢å‡º| CRASH1[ğŸ’¥ OOMå´©æºƒ]
    C2 -->|CPUæ‰“æ»¡| CRASH2[ğŸ’¥ CPU 100%]
    C3 -->|GCé¢‘ç¹| CRASH3[ğŸ’¥ é¢‘ç¹GCå¡æ­»]
    
    CRASH1 -.->|é‡å¯| RESTART[è‡ªåŠ¨é‡å¯]
    RESTART -.->|ç»§ç»­è¢«æ‰“æŒ‚| CRASH1
    
    style Q fill:#F44336,stroke:#D32F2F,stroke-width:2px,rx:10,ry:10
    style CRASH1 fill:#FF5722,stroke:#E64A19,stroke-width:2px,rx:10,ry:10
    style CRASH2 fill:#FF5722,stroke:#E64A19,stroke-width:2px,rx:10,ry:10
    style CRASH3 fill:#FF5722,stroke:#E64A19,stroke-width:2px,rx:10,ry:10
```

### QoS(Quality of Service)é™æµåŸç†

RabbitMQé€šè¿‡`basicQos`æ–¹æ³•å®ç°æ¶ˆè´¹ç«¯é™æµ,æ ¸å¿ƒæ€æƒ³æ˜¯**æ§åˆ¶æœªç¡®è®¤æ¶ˆæ¯æ•°é‡**:

```mermaid
sequenceDiagram
    participant Q as é˜Ÿåˆ—
    participant MQ as RabbitMQæœåŠ¡å™¨
    participant C as æ¶ˆè´¹è€…
    
    C->>MQ: è®¾ç½®prefetchCount=3<br/>æœ€å¤š3æ¡æœªç¡®è®¤æ¶ˆæ¯
    
    MQ->>C: æ¨é€æ¶ˆæ¯1
    MQ->>C: æ¨é€æ¶ˆæ¯2
    MQ->>C: æ¨é€æ¶ˆæ¯3
    
    Note over MQ,C: å·²è¾¾ä¸Šé™,åœæ­¢æ¨é€
    
    C->>C: å¤„ç†æ¶ˆæ¯1
    C->>MQ: ACKæ¶ˆæ¯1
    
    Note over MQ: æœªç¡®è®¤æ•°å˜ä¸º2<br/>å¯ä»¥ç»§ç»­æ¨é€
    
    MQ->>Q: æ‹‰å–ä¸‹ä¸€æ¡æ¶ˆæ¯
    MQ->>C: æ¨é€æ¶ˆæ¯4
    
    C->>C: å¤„ç†æ¶ˆæ¯2
    C->>MQ: ACKæ¶ˆæ¯2
    MQ->>C: æ¨é€æ¶ˆæ¯5
```

**å·¥ä½œæµç¨‹**:
1. æ¶ˆè´¹è€…è®¾ç½®`prefetchCount=N`,è¡¨ç¤ºæœ€å¤šåŒæ—¶å¤„ç†Næ¡æ¶ˆæ¯
2. RabbitMQæ¨é€Næ¡æ¶ˆæ¯ååœæ­¢,ç­‰å¾…æ¶ˆè´¹è€…ç¡®è®¤
3. æ¯å½“æ¶ˆè´¹è€…å‘é€1ä¸ªACK,RabbitMQå°±å†æ¨é€1æ¡æ–°æ¶ˆæ¯
4. å§‹ç»ˆä¿æŒæœªç¡®è®¤æ¶ˆæ¯æ•°â‰¤N,å®ç°æµé‡æ§åˆ¶

### é™æµé…ç½®å®ç°

#### 1. å…³é—­è‡ªåŠ¨ç¡®è®¤

é™æµæœºåˆ¶ä¾èµ–æ‰‹åŠ¨ACK,å¿…é¡»å…ˆç¦ç”¨è‡ªåŠ¨ç¡®è®¤:

```java
// autoAck=false,å…³é—­è‡ªåŠ¨ç¡®è®¤
channel.basicConsume(queueName, false, consumer);
```

#### 2. è®¾ç½®QoSå‚æ•°

```java
/**
 * basicQoså‚æ•°è¯´æ˜:
 * @param prefetchSize  å•æ¡æ¶ˆæ¯å¤§å°é™åˆ¶(å­—èŠ‚),0è¡¨ç¤ºä¸é™åˆ¶
 * @param prefetchCount æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ä¸Šé™,æ ¸å¿ƒå‚æ•°
 * @param global        ä½œç”¨èŒƒå›´: false=Channelçº§åˆ«, true=Consumerçº§åˆ«
 */
channel.basicQos(0, 10, false);
```

**å‚æ•°è¯¦è§£**:
- `prefetchSize`: é€šå¸¸è®¾ä¸º0,ä¸é™åˆ¶å•æ¡æ¶ˆæ¯å¤§å°
- `prefetchCount`: **å…³é”®å‚æ•°**,å»ºè®®æ ¹æ®æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›è®¾ç½®(å¦‚10-50)
- `global`: 
  - `false`: é™åˆ¶å½“å‰Channel,ä¸€ä¸ªChannelå¯èƒ½æœ‰å¤šä¸ªConsumer
  - `true`: é™åˆ¶å•ä¸ªConsumer

#### 3. æ‰‹åŠ¨å‘é€ACK

```java
// å¤„ç†å®Œä¸€æ¡æ¶ˆæ¯å,æ‰‹åŠ¨ç¡®è®¤
channel.basicAck(deliveryTag, false);
```

### å®Œæ•´é™æµç¤ºä¾‹

```java
import com.rabbitmq.client.*;
import java.io.IOException;

public class FlowControlConsumer {
    
    private static final String QUEUE_NAME = "order_queue";
    private static final String HOST = "localhost";
    
    public static void main(String[] args) throws Exception {
        ConnectionFactory factory = new ConnectionFactory();
        factory.setHost(HOST);
        
        Connection connection = factory.newConnection();
        Channel channel = connection.createChannel();
        
        // å£°æ˜é˜Ÿåˆ—
        channel.queueDeclare(QUEUE_NAME, true, false, false, null);
        
        // ========== æ ¸å¿ƒé…ç½®:è®¾ç½®æ¶ˆè´¹ç«¯é™æµ ==========
        // æ¯æ¬¡æœ€å¤šæ‹‰å–5æ¡æ¶ˆæ¯,å¤„ç†å®Œæ‰ç»§ç»­æ‹‰å–
        int prefetchCount = 5;
        channel.basicQos(prefetchCount);
        
        // åˆ›å»ºæ¶ˆè´¹è€…
        DefaultConsumer consumer = new DefaultConsumer(channel) {
            @Override
            public void handleDelivery(String consumerTag, 
                                      Envelope envelope,
                                      AMQP.BasicProperties properties, 
                                      byte[] body) throws IOException {
                String message = new String(body, "UTF-8");
                long deliveryTag = envelope.getDeliveryTag();
                
                try {
                    // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†è€—æ—¶(å¦‚æ•°æ®åº“æ“ä½œ)
                    System.out.println("[" + Thread.currentThread().getName() + "] " +
                                     "å¼€å§‹å¤„ç†è®¢å•: " + message);
                    Thread.sleep(2000);  // æ¨¡æ‹Ÿ2ç§’å¤„ç†æ—¶é—´
                    System.out.println("âœ“ è®¢å•å¤„ç†å®Œæˆ: " + message);
                    
                    // å¤„ç†æˆåŠŸ,æ‰‹åŠ¨ç¡®è®¤
                    channel.basicAck(deliveryTag, false);
                    
                } catch (InterruptedException e) {
                    System.err.println("âœ— è®¢å•å¤„ç†å¼‚å¸¸: " + message);
                    // å¤„ç†å¤±è´¥,æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
                    channel.basicNack(deliveryTag, false, true);
                }
            }
        };
        
        // å…³é—­è‡ªåŠ¨ç¡®è®¤,å¯ç”¨æ‰‹åŠ¨ACK
        channel.basicConsume(QUEUE_NAME, false, consumer);
        
        System.out.println("æ¶ˆè´¹è€…å¯åŠ¨,é™æµé…ç½®: prefetchCount=" + prefetchCount);
    }
}
```

### é™æµå‚æ•°è°ƒä¼˜ç­–ç•¥

| æ¶ˆè´¹è€…æ€§èƒ½ | å»ºè®®prefetchCount | é€‚ç”¨åœºæ™¯ |
|-----------|------------------|---------|
| é«˜æ€§èƒ½(çº¯å†…å­˜è®¡ç®—) | 50-100 | æ—¥å¿—åˆ†æã€æ•°æ®ç»Ÿè®¡ |
| ä¸­ç­‰(å«æ•°æ®åº“æ“ä½œ) | 10-30 | è®¢å•å¤„ç†ã€ç”¨æˆ·æ³¨å†Œ |
| ä½æ€§èƒ½(è€—æ—¶ä»»åŠ¡) | 1-5 | è§†é¢‘è½¬ç ã€æ–‡ä»¶ä¸Šä¼  |
| æä½æ€§èƒ½(å¤–éƒ¨APIè°ƒç”¨) | 1 | ç¬¬ä¸‰æ–¹æ”¯ä»˜å›è°ƒã€é‚®ä»¶å‘é€ |

**è°ƒä¼˜åŸåˆ™**:
- prefetchCountè¿‡å¤§: å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…è¿‡è½½,å†…å­˜æº¢å‡º
- prefetchCountè¿‡å°: ç½‘ç»œå¾€è¿”æ¬¡æ•°å¢åŠ ,ååé‡ä¸‹é™
- å»ºè®®é€šè¿‡å‹æµ‹æ‰¾åˆ°æœ€ä¼˜å€¼,å…¼é¡¾ååé‡å’Œç¨³å®šæ€§

### é™æµçš„å±€é™æ€§

è™½ç„¶é™æµå¯ä»¥ä¿æŠ¤æ¶ˆè´¹è€…,ä½†**æ— æ³•æ ¹æœ¬è§£å†³æ¶ˆæ¯ç§¯å‹é—®é¢˜**,æ²»æ ‡ä¸æ²»æœ¬:

```mermaid
graph LR
    P[ç”Ÿäº§è€…<br/>1000 msg/s] -->|å†™å…¥| Q[é˜Ÿåˆ—]
    Q -->|é™æµå<br/>100 msg/s| C[æ¶ˆè´¹è€…]
    
    Q -.->|ç§¯å‹é€Ÿåº¦<br/>900 msg/s| BACKLOG[æ¶ˆæ¯å †ç§¯<br/>æŒç»­å¢é•¿]
    
    style Q fill:#F44336,stroke:#D32F2F,stroke-width:2px,rx:10,ry:10
    style BACKLOG fill:#FF9800,stroke:#F57C00,stroke-width:2px,rx:10,ry:10
```

**æ ¹æœ¬è§£å†³æ–¹æ¡ˆ**:
1. **æ°´å¹³æ‰©å±•**: å¢åŠ æ¶ˆè´¹è€…å®ä¾‹æ•°é‡,æå‡æ•´ä½“æ¶ˆè´¹èƒ½åŠ›
2. **æ€§èƒ½ä¼˜åŒ–**: ä¼˜åŒ–æ¶ˆè´¹è€…ä¸šåŠ¡é€»è¾‘,å¦‚æ‰¹é‡å¤„ç†ã€å¼‚æ­¥åŒ–
3. **å‰Šå³°å¡«è°·**: ç”Ÿäº§ç«¯å®ç°é™æµ,æ§åˆ¶æ¶ˆæ¯å‘é€é€Ÿç‡

## æ¶ˆæ¯å¹‚ç­‰æ€§ä¿éšœ

### é‡å¤æ¶ˆè´¹çš„æ ¹æœ¬åŸå› 

RabbitMQçš„æ¶ˆè´¹ç¡®è®¤æœºåˆ¶è™½ç„¶ä¿è¯äº†æ¶ˆæ¯ä¸ä¸¢å¤±,ä½†**æ— æ³•ä¿è¯æ¶ˆæ¯ä¸é‡å¤**ã€‚ç½‘ç»œå»¶è¿Ÿæˆ–æ•…éšœå¯èƒ½å¯¼è‡´åŒä¸€æ¶ˆæ¯è¢«æŠ•é€’å¤šæ¬¡:

```mermaid
sequenceDiagram
    participant Q as é˜Ÿåˆ—
    participant C as æ¶ˆè´¹è€…
    participant DB as æ•°æ®åº“
    
    Q->>C: æ¨é€æ¶ˆæ¯(orderId=10001)
    C->>DB: æ‰£å‡åº“å­˜ -1
    DB-->>C: æ‰§è¡ŒæˆåŠŸ
    C->>Q: å‘é€ACKç¡®è®¤
    
    Note over C,Q: ğŸ’¥ ç½‘ç»œå»¶è¿Ÿ<br/>ACKæœªé€è¾¾
    
    Note over Q: æœªæ”¶åˆ°ACK<br/>åˆ¤å®šæ¶ˆæ¯æœªå¤„ç†
    
    Q->>C: å†æ¬¡æ¨é€æ¶ˆæ¯(orderId=10001)
    C->>DB: å†æ¬¡æ‰£å‡åº“å­˜ -1
    
    Note over DB: ğŸ”¥ åº“å­˜è¢«æ‰£å‡2æ¬¡<br/>æ•°æ®ä¸ä¸€è‡´!
```

**å¸¸è§è§¦å‘åœºæ™¯**:
1. æ¶ˆè´¹è€…å¤„ç†æˆåŠŸ,ä½†ACKåœ¨ç½‘ç»œä¸­ä¸¢å¤±
2. æ¶ˆè´¹è€…å¤„ç†è¶…æ—¶,RabbitMQè§¦å‘æ¶ˆæ¯é‡æŠ•
3. æ¶ˆè´¹è€…å®•æœºé‡å¯,æœªç¡®è®¤æ¶ˆæ¯è¢«é‡æ–°æŠ•é€’

### å¹‚ç­‰æ€§ä¿éšœæ–¹æ¡ˆ

æ¶ˆè´¹è€…ç«¯å¿…é¡»è‡ªè¡Œå®ç°å¹‚ç­‰æ§åˆ¶,æ ¸å¿ƒæ€æƒ³æ˜¯**é€šè¿‡å”¯ä¸€æ ‡è¯†ç¬¦å»é‡**,é‡‡ç”¨ç»å…¸çš„"ä¸€é”ã€äºŒåˆ¤ã€ä¸‰æ›´æ–°"æ¨¡å¼ã€‚

#### æ–¹æ¡ˆè®¾è®¡

```mermaid
graph TB
    MSG[æ¥æ”¶æ¶ˆæ¯] --> PARSE[è§£æå”¯ä¸€æ ‡è¯†<br/>messageId]
    
    PARSE --> LOCK[1.åŠ é”<br/>åˆ†å¸ƒå¼é”æˆ–æ•°æ®åº“è¡Œé”]
    LOCK --> CHECK[2.åˆ¤é‡<br/>æŸ¥è¯¢æ¶ˆæ¯å¤„ç†è®°å½•è¡¨]
    
    CHECK -->|å·²å¤„ç†| RETURN[ç›´æ¥è¿”å›ACK<br/>å¹‚ç­‰ä¿è¯]
    CHECK -->|æœªå¤„ç†| PROCESS[3.æ‰§è¡Œä¸šåŠ¡+è®°å½•]
    
    PROCESS --> TX_START[å¼€å¯æ•°æ®åº“äº‹åŠ¡]
    TX_START --> BIZ[ä¸šåŠ¡æ“ä½œ<br/>å¦‚æ‰£å‡åº“å­˜]
    BIZ --> RECORD[æ’å…¥æ¶ˆæ¯å¤„ç†è®°å½•<br/>messageId+çŠ¶æ€]
    RECORD --> TX_COMMIT[æäº¤äº‹åŠ¡]
    TX_COMMIT --> ACK[å‘é€ACK]
    
    LOCK -.->|å¤„ç†å®Œæˆ| UNLOCK[é‡Šæ”¾é”]
    
    style LOCK fill:#4CAF50,stroke:#388E3C,stroke-width:2px,rx:10,ry:10
    style CHECK fill:#2196F3,stroke:#1976D2,stroke-width:2px,rx:10,ry:10
    style RECORD fill:#FF9800,stroke:#F57C00,stroke-width:2px,rx:10,ry:10
```

#### å®ç°æ­¥éª¤è¯¦è§£

**1. ç”Ÿäº§è€…ç”Ÿæˆå”¯ä¸€æ ‡è¯†**

åœ¨å‘é€æ¶ˆæ¯æ—¶,ä¸ºæ¯æ¡æ¶ˆæ¯åˆ†é…å…¨å±€å”¯ä¸€ID:

```java
import java.util.UUID;

@Service
public class IdempotentProducer {
    
    @Autowired
    private RabbitTemplate rabbitTemplate;
    
    public void sendOrderMessage(Long orderId, Integer quantity) {
        // ç”Ÿæˆå”¯ä¸€æ¶ˆæ¯ID
        String messageId = UUID.randomUUID().toString();
        
        // æ„å»ºæ¶ˆæ¯ä½“
        OrderMessage message = new OrderMessage();
        message.setMessageId(messageId);
        message.setOrderId(orderId);
        message.setQuantity(quantity);
        
        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend("order_exchange", 
                                     "order.create", 
                                     message);
        
        System.out.println("å‘é€è®¢å•æ¶ˆæ¯, messageId: " + messageId);
    }
}
```

**2. æ¶ˆè´¹è€…å¹‚ç­‰å¤„ç†**

```java
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

@Component
public class IdempotentConsumer {
    
    @Autowired
    private MessageRecordMapper messageRecordMapper;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private RedissonClient redissonClient;
    
    @RabbitListener(queues = "order_queue")
    @Transactional(rollbackFor = Exception.class)
    public void handleOrderMessage(OrderMessage message) {
        String messageId = message.getMessageId();
        
        // 1ï¸âƒ£ åŠ é” - é˜²æ­¢å¹¶å‘é‡å¤å¤„ç†
        RLock lock = redissonClient.getLock("msg_lock:" + messageId);
        
        try {
            // å°è¯•åŠ é”,æœ€å¤šç­‰å¾…5ç§’,é”è¶…æ—¶æ—¶é—´30ç§’
            if (!lock.tryLock(5, 30, TimeUnit.SECONDS)) {
                System.err.println("è·å–é”å¤±è´¥,æ”¾å¼ƒå¤„ç†: " + messageId);
                return;
            }
            
            // 2ï¸âƒ£ åˆ¤é‡ - æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†
            MessageRecord record = messageRecordMapper.selectByMessageId(messageId);
            if (record != null && "SUCCESS".equals(record.getStatus())) {
                System.out.println("âš  æ¶ˆæ¯å·²å¤„ç†è¿‡,å¹‚ç­‰è·³è¿‡: " + messageId);
                return;  // å¹‚ç­‰ä¿è¯:é‡å¤æ¶ˆæ¯ç›´æ¥è¿”å›
            }
            
            // 3ï¸âƒ£ æ›´æ–° - æ‰§è¡Œä¸šåŠ¡å¹¶è®°å½•
            try {
                // æ‰§è¡Œä¸šåŠ¡é€»è¾‘(å¦‚æ‰£å‡åº“å­˜)
                inventoryService.deductStock(
                    message.getOrderId(), 
                    message.getQuantity()
                );
                
                // æ’å…¥æ¶ˆæ¯å¤„ç†è®°å½•(ä¸ä¸šåŠ¡æ“ä½œåœ¨åŒä¸€äº‹åŠ¡)
                MessageRecord newRecord = new MessageRecord();
                newRecord.setMessageId(messageId);
                newRecord.setStatus("SUCCESS");
                newRecord.setProcessTime(new Date());
                messageRecordMapper.insert(newRecord);
                
                System.out.println("âœ“ è®¢å•å¤„ç†æˆåŠŸ: " + messageId);
                
            } catch (Exception e) {
                // ä¸šåŠ¡å¤±è´¥,è®°å½•å¤±è´¥çŠ¶æ€
                MessageRecord failRecord = new MessageRecord();
                failRecord.setMessageId(messageId);
                failRecord.setStatus("FAILED");
                failRecord.setErrorMsg(e.getMessage());
                messageRecordMapper.insert(failRecord);
                
                throw e;  // æŠ›å‡ºå¼‚å¸¸,è§¦å‘æ¶ˆæ¯é‡è¯•
            }
            
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            // é‡Šæ”¾é”
            if (lock.isHeldByCurrentThread()) {
                lock.unlock();
            }
        }
    }
}
```

**3. æ•°æ®åº“è¡¨è®¾è®¡**

```sql
CREATE TABLE message_record (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    message_id VARCHAR(64) NOT NULL UNIQUE COMMENT 'æ¶ˆæ¯å”¯ä¸€æ ‡è¯†',
    status VARCHAR(20) NOT NULL COMMENT 'å¤„ç†çŠ¶æ€:SUCCESS/FAILED',
    error_msg VARCHAR(500) COMMENT 'å¤±è´¥åŸå› ',
    process_time DATETIME COMMENT 'å¤„ç†æ—¶é—´',
    INDEX idx_message_id (message_id)
) COMMENT 'æ¶ˆæ¯å¤„ç†è®°å½•è¡¨';
```

### å¹‚ç­‰æ€§æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| æ•°æ®åº“å”¯ä¸€ç´¢å¼• | ç®€å•,ä¾èµ–DBä¿è¯ | æ€§èƒ½ä¸€èˆ¬,å¼ºä¾èµ–æ•°æ®åº“ | ä¸­å°è§„æ¨¡ç³»ç»Ÿ |
| Redis Setå»é‡ | æ€§èƒ½é«˜,å“åº”å¿« | éœ€è¦å¤„ç†ç¼“å­˜å¤±æ•ˆé—®é¢˜ | é«˜å¹¶å‘åœºæ™¯ |
| åˆ†å¸ƒå¼é”+çŠ¶æ€è¡¨ | å¯é æ€§é«˜,å¯å®¡è®¡ | å®ç°å¤æ‚,éœ€è¦é”ç®¡ç† | é‡‘èã€ç”µå•†ç­‰å…³é”®ä¸šåŠ¡ |
| ä¸šåŠ¡ä¸»é”®å»é‡ | å¤©ç„¶å¹‚ç­‰,æ— é¢å¤–å¼€é”€ | éœ€è¦ä¸šåŠ¡æ”¯æŒ,ä¸é€šç”¨ | è®¢å•å·ã€äº¤æ˜“æµæ°´å·ç­‰ |

### æœ€ä½³å®è·µå»ºè®®

1. **ä¼˜å…ˆä½¿ç”¨ä¸šåŠ¡ä¸»é”®å»é‡**: å¦‚è®¢å•IDã€ç”¨æˆ·ID+æ—¶é—´æˆ³ç»„åˆ,é¿å…é¢å¤–å­˜å‚¨
2. **æ¶ˆæ¯IDç”Ÿæˆè§„åˆ™**: å»ºè®®ä½¿ç”¨é›ªèŠ±ç®—æ³•æˆ–UUID,ä¿è¯å…¨å±€å”¯ä¸€æ€§
3. **çŠ¶æ€è¡¨å®šæœŸæ¸…ç†**: è®¾ç½®TTLæˆ–å®šæ—¶ä»»åŠ¡æ¸…ç†å†å²æ•°æ®,é¿å…è¡¨è†¨èƒ€
4. **é”è¶…æ—¶è®¾ç½®**: é”è¶…æ—¶æ—¶é—´åº”å¤§äºä¸šåŠ¡å¤„ç†æ—¶é—´,é¿å…é”æå‰é‡Šæ”¾å¯¼è‡´é‡å¤å¤„ç†
5. **ç›‘æ§å‘Šè­¦**: å¯¹é‡å¤æ¶ˆæ¯æ¯”ä¾‹è¿›è¡Œç›‘æ§,å¼‚å¸¸æ—¶åŠæ—¶å‘Šè­¦

## ç»¼åˆæ¡ˆä¾‹:é«˜å¯ç”¨è®¢å•å¤„ç†ç³»ç»Ÿ

ç»“åˆé™æµå’Œå¹‚ç­‰æ€§,æ„å»ºä¸€ä¸ªå¥å£®çš„è®¢å•æ¶ˆè´¹è€…:

```java
@Component
public class RobustOrderConsumer {
    
    @Autowired
    private OrderService orderService;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * é«˜å¯é è®¢å•å¤„ç†æ¶ˆè´¹è€…
     * - å¯ç”¨é™æµä¿æŠ¤
     * - å®ç°å¹‚ç­‰æ€§ä¿éšœ
     * - å¼‚å¸¸é‡è¯•ç­–ç•¥
     */
    @RabbitListener(
        queues = "order_queue",
        concurrency = "5-10",  // åŠ¨æ€æ‰©å®¹:5-10ä¸ªå¹¶å‘æ¶ˆè´¹è€…
        ackMode = "MANUAL"     // æ‰‹åŠ¨ç¡®è®¤
    )
    public void processOrder(OrderMessage message, 
                            Channel channel,
                            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        
        String messageId = message.getMessageId();
        String idempotentKey = "order:processed:" + messageId;
        
        try {
            // å¹‚ç­‰æ€§æ£€æŸ¥:Redisåˆ†å¸ƒå¼å»é‡
            Boolean isProcessed = redisTemplate.opsForValue()
                .setIfAbsent(idempotentKey, "1", 24, TimeUnit.HOURS);
            
            if (Boolean.FALSE.equals(isProcessed)) {
                System.out.println("âš  è®¢å•é‡å¤,å¹‚ç­‰è·³è¿‡: " + messageId);
                channel.basicAck(deliveryTag, false);
                return;
            }
            
            // æ‰§è¡Œè®¢å•ä¸šåŠ¡å¤„ç†
            orderService.createOrder(message);
            
            // å¤„ç†æˆåŠŸ,æ‰‹åŠ¨ACK
            channel.basicAck(deliveryTag, false);
            System.out.println("âœ“ è®¢å•å¤„ç†æˆåŠŸ: " + message.getOrderId());
            
        } catch (BusinessException e) {
            // ä¸šåŠ¡å¼‚å¸¸(å¦‚åº“å­˜ä¸è¶³),æ‹’ç»æ¶ˆæ¯ä¸é‡è¯•
            try {
                channel.basicReject(deliveryTag, false);
                // æ¸…ç†å¹‚ç­‰æ ‡è®°,å…è®¸åç»­ä¿®å¤æ•°æ®åé‡æ–°å¤„ç†
                redisTemplate.delete(idempotentKey);
            } catch (IOException ioException) {
                ioException.printStackTrace();
            }
            System.err.println("âœ— è®¢å•ä¸šåŠ¡å¼‚å¸¸: " + e.getMessage());
            
        } catch (Exception e) {
            // ç³»ç»Ÿå¼‚å¸¸(å¦‚ç½‘ç»œè¶…æ—¶),NACKå¹¶é‡æ–°å…¥é˜Ÿ
            try {
                channel.basicNack(deliveryTag, false, true);
                // ä¿ç•™å¹‚ç­‰æ ‡è®°,é˜²æ­¢é‡è¯•æ—¶é‡å¤æ‰§è¡Œ
            } catch (IOException ioException) {
                ioException.printStackTrace();
            }
            System.err.println("âœ— è®¢å•ç³»ç»Ÿå¼‚å¸¸,æ¶ˆæ¯é‡è¯•: " + e.getMessage());
        }
    }
}
```

**é…ç½®æ–‡ä»¶(application.yml)**:

```yaml
spring:
  rabbitmq:
    listener:
      simple:
        # æ¶ˆè´¹ç«¯é™æµé…ç½®
        prefetch: 10  # æ¯ä¸ªæ¶ˆè´¹è€…æœ€å¤š10æ¡æœªç¡®è®¤æ¶ˆæ¯
        # æ‰‹åŠ¨ACKæ¨¡å¼
        acknowledge-mode: manual
        # å¹¶å‘æ¶ˆè´¹è€…æ•°é‡
        concurrency: 5
        max-concurrency: 20
```

é€šè¿‡é™æµå’Œå¹‚ç­‰æ€§çš„åŒé‡ä¿éšœ,ç³»ç»Ÿèƒ½å¤Ÿåœ¨é«˜å¹¶å‘ã€ç½‘ç»œä¸ç¨³å®šç­‰æ¶åŠ£ç¯å¢ƒä¸‹ç¨³å®šè¿è¡Œ,é¿å…æ¶ˆæ¯é‡å¤å¤„ç†å’Œæ¶ˆè´¹è€…è¿‡è½½é—®é¢˜ã€‚
