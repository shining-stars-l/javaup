---
slug: /architecture/seata/at-mode-analysis
---

import PaidCTA from '@site/src/components/PaidCTA';

# AT模式深度剖析与隔离性问题

## AT模式的实现原理

AT模式（Auto-Commit Transaction）是Seata中使用最广泛的事务模式，它通过数据源代理的方式实现了对业务代码的零侵入。理解AT模式的底层实现机制，对于正确使用它、排查问题至关重要。

### 数据源代理机制

AT模式的核心是**数据源代理**。Seata在应用的DataSource之上包装了一层代理层，将原本的JDBC DataSource转换为Seata DataSourceProxy。这样就可以在代理层拦截所有的SQL执行，控制事务的提交和回滚。

```mermaid
graph TB
    A[业务代码] --> B[Seata DataSourceProxy]
    B --> C[SQL解析器]
    B --> D[UndoLog生成器]
    B --> E[全局锁管理]
    B --> F[原始DataSource]
    F --> G[数据库]
    
    C -.-> H[解析SQL类型<br/>表名/字段/条件]
    D -.-> I[生成before/after镜像]
    E -.-> J[申请/释放全局锁]
    
    style A fill:#a8e6cf,stroke:#333,stroke-width:2px,rx:10,ry:10
    style B fill:#ffd3b6,stroke:#333,stroke-width:2px,rx:10,ry:10
    style F fill:#dcedc1,stroke:#333,stroke-width:2px,rx:10,ry:10
    style G fill:#dcedc1,stroke:#333,stroke-width:2px,rx:10,ry:10
```

### 两阶段提交详解

AT模式将事务分为两个阶段执行，每个阶段都有明确的职责和执行步骤。

#### 第一阶段：业务SQL执行与日志记录

```mermaid
sequenceDiagram
    participant App as 应用程序
    participant Proxy as DataSourceProxy
    participant TC as 事务协调器
    participant DB as 数据库

    App->>Proxy: 执行UPDATE语句
    Proxy->>Proxy: 1.解析SQL
    Proxy->>DB: 2.查询变更前数据(before image)
    DB-->>Proxy: 返回当前数据
    Proxy->>DB: 3.执行业务SQL
    DB-->>Proxy: 执行成功
    Proxy->>DB: 4.查询变更后数据(after image)
    DB-->>Proxy: 返回新数据
    Proxy->>DB: 5.插入undo log
    Proxy->>TC: 6.注册分支并申请全局锁
    TC-->>Proxy: 注册成功
    Proxy->>DB: 7.提交本地事务
    Proxy-->>App: 返回执行结果
```

**详细步骤说明：**

<PaidCTA />