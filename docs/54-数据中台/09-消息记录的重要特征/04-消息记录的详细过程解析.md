---
slug: /dock-data-center/message-record/detail
---

import PaidCTA from '@site/src/components/PaidCTA';

# 消息记录的详细过程解析

在上一章节中，详细介绍了消息记录能解决哪些问题，以及相关的表设计。而本章节会详细讲解消息记录的执行过程

# 发送消息流程

首先就是来到经典责任链模式中的最后一个节点，也就是 **升级维度节点**

## 处理逻辑要点：

1. 先做维度升级计算：若已到顶（`PARENT_VIDEO_TYPE` 且 `YEAR`），停止；否则生成“下一跳维度参数”。

2. 生成消息发送记录（落库，状态为未发送），并同时写入“视频业务维度发送记录”。

3. 调用升级消息发送器，将消息发往 Kafka。
4. 根据发送后的状态更新消息发送记录，包括：正常、异常

org.javaup.chain.impl.UpgradeDimensionDataChainHandler#handler

```java
@Override
protected void handler(TotalParamTransfers totalParamTransfers) {
    //执行维度升级
    ParamTransfers newParamTransfers = doUpgradeDimension(totalParamTransfers);
    //如果newParamTransfers为空，说明维度已经升级到最高了，不需要再发型消息了
    if (Objects.isNull(newParamTransfers)) {
        return;
    }
    totalParamTransfers.setParamTransfers(newParamTransfers);
    MessageProducerRecord messageProducerRecord = messageProducerRecordService.insertMessageProducerRecord(totalParamTransfers);
    UpDimensionDomain upDimensionDomain = upgradeDimensionHandler.upgradeDimension(messageProducerRecord.getId(),
            messageProducerRecord.getMessageId(),totalParamTransfers);
    if (Objects.nonNull(upDimensionDomain.getDockDataCenterFrameException())) {
        throw upDimensionDomain.getDockDataCenterFrameException();
    }
}
```

## 先做维度升级计算

```java
public ParamTransfers doUpgradeDimension(TotalParamTransfers totalParamTransfers){
    //视频维度
    VideoDimensionType videoDimensionType = totalParamTransfers.getParamTransfers().getVideoDimensionType();
    //时间类型
    DateType dateType = totalParamTransfers.getParamTransfers().getRequestTime().getDateType();
    //如果视频维度是父级的视频分类，并且时间维度是年维度，那么就不需要再进行升级了
    if (videoDimensionType == VideoDimensionType.PARENT_VIDEO_TYPE && dateType == DateType.YEAR) {
        log.info("一次的所有维度采集完成， 规则id:{}, 采集日期:{}", totalParamTransfers.getParamTransfers().getRuleId(),
                totalParamTransfers.getParamTransfers().getRequestTime().getGatherDate());
        return null;
    }
    //维度的升级
    ParamTransfers newParamTransfers = upgradeDimensionParam(totalParamTransfers.getParamTransfers());
    if (Objects.isNull(newParamTransfers)) {
        return null;
    }
    log.info("维度升级执行，升级前的时间维度:{}, 升级前的视频维度:{}, 升级后的时间维度:{}, 升级后的视频维度:{}",
            dateType.getMsg(), videoDimensionType.getMsg(),
            newParamTransfers.getRequestTime().getDateType().getMsg(),
            newParamTransfers.getVideoDimensionType().getMsg());
    return newParamTransfers;
}
```
<PaidCTA />
